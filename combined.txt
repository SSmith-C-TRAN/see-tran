# Project Directory Structure
./
    .flaskenv
    run.py
    flask_setup.sh
    index.html
    tailwind.config.js
    gtfs_loader.py
    .DS_Store
    config.py
    requirements.txt
    cat.py
    404.html
    README.md
    .nojekyll
    .gitignore
    package-lock.json
    package.json
    .nvmrc
    postcss.config.js
    app/
        auth.py
        .DS_Store
        __init__.py
        forms/
            __init__.py
            forms.py
        agents/
            agency_agent.py
            __init__.py
            component_agent.py
            base.py
            vendor_agent.py
            tools/
                __init__.py
                image_fetch.py
            providers/
                __init__.py
                openai.py
                anthropic.py
        utils/
            logging.py
            __init__.py
            afi.py
            errors.py
        models/
            tran.py
            __init__.py
            gtfs.py
        static/
            .DS_Store
            css/
                .keep
            images/
                favicon.ico
                ST.png
                logo.old
                favicon.old
                logo.png
                transit_logos/
                    spokane_logo.png
                    kingco_logo.png
                    intercity_logo.png
                    island_logo.png
                    godurham_logo.png
                    chapelhill_logo.png
                    cota_logo.png
                    c-tran_logo.png
                    trimet_logo.png
                vendor_logos/
                    init_logo.png
                    apollo_logo.png
                    byd_logo.png
                transit_headers/
                    cota_header.png
                    c-tran_header.png
                vendor_headers/
                    apollo_header.png
            js/
                .keep
                main.js
                vendor-page-controller.js
        templates/
            configurations.html
            integration_form.html
            agency_implementations.html
            index.html
            registration_required.html
            base.html
            products.html
            components.html
            standards.html
            functions_print.html
            functional_areas_print.html
            login.html
            integrations.html
            functional_areas.html
            component_detail.html
            configurations_import.html
            docs.html
            agencies.html
            contribute.html
            vendors.html
            fragments/
                vendor_details.html
                vendor_form.html
                configuration_edit_form.html
                product_versions_list.html
                wizard_config_step4.html
                configuration_history.html
                vendor_list.html
                wizard_config_step3.html
                wizard_config_step2.html
                agency_details.html
                wizard_afi_step2_components.html
                wizard_afi_step4_review.html
                functional_area_details.html
                configuration_list.html
                product_details.html
                wizard_afi_step1.html
                agency_list.html
                wizard_config_step1.html
                product_version_form.html
                product_picker_options.html
                afi_history.html
                functional_area_form.html
                configuration_products_list.html
                component_form.html
                product_form.html
                configuration_product_form.html
                configuration_details.html
                configuration_row.html
                wizard_afi_step3_details.html
                functional_area_list.html
                agency_form.html
                component_list.html
                product_list.html
                afi_row.html
                afi_list.html
                afi_edit_form.html
            admin/
                dashboard.html
                agency_agent.html
        routes/
            configurations.py
            agency.py
            __init__.py
            admin.py
            main.py
            integrations.py
    tests/
        test_phase2_functional_areas.py
        test_auth.py
        test_phase2.py
        __init__.py
        test_vendors_crud.py
        test_phase1.py
        test_app.py
    docs/
        README_setup.md
        index.html
        utility_commands.md
        README_next.md
        README_agents.md
    tailwind/
        config.js
        input.css
    logs/
        agent_audit.jsonl
    .github/
        workflows/
            pages.yml
    assets/
        site.css

# End of Directory Structure

# Start of app/__init__.py
from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate
from flask_wtf import CSRFProtect
import os

db = SQLAlchemy()
migrate = Migrate()
csrf = CSRFProtect()

def create_app(test_config=None):
    app = Flask(__name__)
    
    if test_config:
        app.config.update(test_config)
    else:
        # Import config classes
        from config import DevelopmentConfig, ProductionConfig, TestConfig
        
        # Use DevelopmentConfig by default, or based on environment
        flask_env = os.environ.get('FLASK_ENV', 'development')
        if flask_env == 'production':
            app.config.from_object(ProductionConfig)
        elif flask_env == 'testing':
            app.config.from_object(TestConfig)
        else:
            app.config.from_object(DevelopmentConfig)
    
    # Ensure the instance folder exists
    try:
        os.makedirs(app.instance_path)
    except OSError:
        pass
    
    db.init_app(app)
    migrate.init_app(app, db)
    csrf.init_app(app)
    
    # Import models so Flask-Migrate can detect them
    with app.app_context():
        from app.models import tran  # Import existing models
        from app.models import gtfs  # Import GTFS models
    
    # register blueprints
    from app.routes.main import main as main_bp
    app.register_blueprint(main_bp)

    from app.routes.agency import agency_bp
    app.register_blueprint(agency_bp)
    from app.routes.integrations import integration_bp
    app.register_blueprint(integration_bp)

    # Register auth routes
    from app.auth import auth_bp
    app.register_blueprint(auth_bp)

    # Register admin routes
    from app.routes import admin as admin_bp
    app.register_blueprint(admin_bp)
    
    # Phase 4 new blueprint
    from app.routes.configurations import config_bp
    app.register_blueprint(config_bp)
    
    return app

# End of app/__init__.py

# Start of config.py
# config.py

import os
from dotenv import load_dotenv
from datetime import timedelta

basedir = os.path.abspath(os.path.dirname(__file__))
load_dotenv(os.path.join(basedir, '.env'))

class Config:
    # Core Flask settings
    SECRET_KEY = os.environ.get('SECRET_KEY')
    DEBUG = os.environ.get('FLASK_ENV') == 'development'
    
    # Database settings - SQLite support
    DB_TYPE = os.environ.get('DB_TYPE', 'sqlite')
    
    if DB_TYPE == 'postgres':
        SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL')
    else:
        # SQLite database
        SQLALCHEMY_DATABASE_URI = f"sqlite:///{os.path.join(basedir, 'instance', 'app.db')}"
    
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    SQLALCHEMY_COMMIT_ON_TEARDOWN = True
    
    # Security settings
    CSRF_ENABLED = True
    
    # Application paths and cookies
    PERMANENT_SESSION_LIFETIME = timedelta(days=7)
    SESSION_REFRESH_EACH_REQUEST = True

    WTF_CSRF_TIME_LIMIT = 24 * 3600  # 24 hours in seconds
    WTF_CSRF_SSL_STRICT = False
    
    # File upload settings
    MAX_CONTENT_LENGTH = 500 * 1024 * 1024  # 500 MB limit
    
    # Email settings
    POSTMARK_API_KEY = os.getenv('POSTMARK_API_KEY')
    POSTMARK_SENDER_EMAIL = os.getenv('POSTMARK_SENDER_EMAIL')
    POSTMARK_NOTIFY_EMAIL = os.getenv('POSTMARK_NOTIFY_EMAIL')

    SUPER_ADMIN_EMAIL = os.getenv('SUPER_ADMIN_EMAIL')

    # LLM API Keys
    CLAUDE_API_KEY = os.environ.get('CLAUDE_API_KEY')
    CLAUDE_API_URL = 'https://api.anthropic.com/v1/messages'
    CLAUDE_MODEL = os.environ.get('CLAUDE_MODEL', 'claude-3-5-haiku-20241022')
    
    OPENAI_API_KEY = os.environ.get('OPENAI_API_KEY')
    
    # Agent Configuration
    AGENT_PROVIDERS = {
        'agency': {
            'provider': os.environ.get('AGENCY_AGENT_PROVIDER', 'anthropic'),
            'model': os.environ.get('AGENCY_AGENT_MODEL', 'claude-sonnet-4-20250514'),
        },
        'vendor': {
            'provider': os.environ.get('VENDOR_AGENT_PROVIDER', 'anthropic'),
            'model': os.environ.get('VENDOR_AGENT_MODEL', 'claude-sonnet-4-20250514'),
        },
        'component': {
            'provider': os.environ.get('COMPONENT_AGENT_PROVIDER', 'anthropic'),
            'model': os.environ.get('COMPONENT_AGENT_MODEL', 'claude-sonnet-4-20250514'),
        },
        'image_fetch': {
            'provider': os.environ.get('IMAGE_AGENT_PROVIDER', 'openai'),
            'model': os.environ.get('IMAGE_AGENT_MODEL', 'gpt-4o'),
        },
    }
    
    AGENT_CONFIDENCE_THRESHOLD = float(os.environ.get('AGENT_CONFIDENCE_THRESHOLD', '0.7'))
    
    # AWS settings
    AWS_ACCESS_KEY_ID = os.environ.get('AWS_ACCESS_KEY_ID')
    AWS_SECRET_ACCESS_KEY = os.environ.get('AWS_SECRET_ACCESS_KEY')
    AWS_REGION = os.environ.get('AWS_REGION', 'us-west-2')
    S3_BUCKET = os.environ.get('S3_BUCKET', 'well-app')
    
    # Application URLs
    SMS_BASE_URL = os.environ.get('SMS_BASE_URL', 'https://see-tran.com')
    
    @staticmethod
    def get_s3_prefix(tenant_id):
        """Generate S3 key prefix for tenant isolation"""
        return f'tenant_{tenant_id}'
    
    # SMS settings
    TWILIO_ACCOUNT_SID = os.getenv('TWILIO_ACCOUNT_SID')
    TWILIO_AUTH_TOKEN = os.getenv('TWILIO_AUTH_TOKEN')
    TWILIO_FROM_NUMBER = os.getenv('TWILIO_FROM_NUMBER')

    SMS_TEST_PHONE_NUMBER = os.environ.get('SMS_TEST_PHONE_NUMBER', '+18084649192')

    # OAuth settings
    OAUTH_GOOGLE_CLIENT_ID = os.environ.get('OAUTH_GOOGLE_CLIENT_ID')
    OAUTH_GOOGLE_CLIENT_SECRET = os.environ.get('OAUTH_GOOGLE_CLIENT_SECRET')
    OAUTH_GOOGLE_DISCOVERY_URL = os.environ.get('OAUTH_GOOGLE_DISCOVERY_URL')

    OAUTH_MS_CLIENT_ID = os.environ.get('OAUTH_MS_CLIENT_ID')
    OAUTH_MS_CLIENT_SECRET = os.environ.get('OAUTH_MS_CLIENT_SECRET')
    OAUTH_MS_DISCOVERY_URL = 'https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration'

class DevelopmentConfig(Config):
    """Development configuration."""
    FLASK_ENV = 'development'
    DEBUG = True
    DEVELOPMENT = True
    
    # More permissive session cookie settings for development
    SESSION_COOKIE_SECURE = False
    SESSION_COOKIE_DOMAIN = None  # Allow all domains in development

class ProductionConfig(Config):
    """Production configuration."""
    DEBUG = False
    DEVELOPMENT = False
    SESSION_COOKIE_SECURE = True
    PREFERRED_URL_SCHEME = 'https'
    
    SESSION_COOKIE_HTTPONLY = True
    SESSION_COOKIE_SAMESITE = 'Lax'
    SESSION_FILE_DIR = '/home/ubuntu/see-tran/flask_session'

class TestConfig(Config):
    """Test configuration."""
    TESTING = True
    DEBUG = False
    SQLALCHEMY_DATABASE_URI = 'sqlite:///:memory:'
    WTF_CSRF_ENABLED = False
# End of config.py

# Start of app/routes/main.py
# app/routes/main.py
from flask import Blueprint, render_template, jsonify, request, url_for, redirect, send_file  # added redirect, send_file
from app import db
from app.models.tran import (
    Agency, FunctionalArea, Component, Vendor, IntegrationPoint,
    UpdateLog, Function, Standard, Tag, TagGroup, UserRole,
    integration_standard, component_integration,
    Configuration, ConfigurationProduct, Product, ProductVersion
)
from app.forms.forms import AgencyForm, VendorForm, ComponentForm
from app.auth import login_required, get_updated_by
from app.utils.errors import (
    json_error_response, json_success_response, 
    html_error_fragment, html_success_fragment,
    json_form_error_response, json_validation_error_response
)
# removed import of AFI utility helpers (create_afi_with_optional_children, component_supports_function, etc.)
from sqlalchemy import func, case, distinct
from sqlalchemy.orm import joinedload
from sqlalchemy.exc import IntegrityError
from datetime import datetime, timedelta
import io  # for Excel streaming


main = Blueprint("main", __name__)

@main.route("/")
def index():
    return render_template("index.html")

# --- Basic pages ---
@main.route("/functional-areas")
def functional_areas_page():
    return render_template('functional_areas.html')

@main.get('/functional-areas/export.xlsx')
def export_functional_areas_excel():
    """Download an Excel export of Functional Areas with their Functions.

    Columns: Functional Area, Function, Criticality, # Components, # Agencies
    Styling: title row, header styling, borders, auto-width, frozen header, autofilter,
    conditional fill by criticality. Import of openpyxl is lazy to avoid import errors
    when the package isn't installed during unrelated operations/tests.
    """
    try:
        # Optional filter parity with the page (currently only a search box)
        search = (request.args.get('search') or '').strip()

        q = (FunctionalArea.query
             .options(joinedload(FunctionalArea.functions))
             .order_by(FunctionalArea.name.asc()))
        if search:
            q = q.filter(FunctionalArea.name.ilike(f"%{search}%"))
        areas = q.all()

        # Lazy import for safety in environments without openpyxl preinstalled
        try:
            from openpyxl import Workbook
            from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
            from openpyxl.utils import get_column_letter
        except Exception as ie:
            return json_error_response(f"Excel export unavailable (dependency): {ie}", 500)

        wb = Workbook()
        ws = wb.active
        ws.title = "Functional Areas"

        # Styles
        title_font = Font(size=14, bold=True)
        subtitle_font = Font(size=10, color="6B7280")
        header_font = Font(color="FFFFFF", bold=True)
        header_fill = PatternFill("solid", fgColor="1F2937")  # slate-800
        thin = Side(style="thin", color="374151")  # slate-700
        border = Border(left=thin, right=thin, top=thin, bottom=thin)

        # Title and metadata
        ws["A1"] = "Functional Areas Export"
        ws["A1"].font = title_font
        ws["A2"] = f"Generated: {datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')}"
        ws["A2"].font = subtitle_font
        ws.merge_cells(start_row=1, start_column=1, end_row=1, end_column=5)

        # Header row
        headers = [
            "Functional Area",
            "Function",
            "Criticality",
            "# Components",
            "# Agencies",
        ]
        ws.append([None])  # row 3 spacer so header lands at row 4 consistently
        ws.append(headers)  # this becomes row 4
        header_row_idx = 4
        for cell in ws[header_row_idx]:
            cell.font = header_font
            cell.fill = header_fill
            cell.alignment = Alignment(vertical="center")
            cell.border = border

        # Data rows
        row = header_row_idx + 1
        severity_order = {"high": 0, "medium": 1, "low": 2}
        crit_fills = {
            "high": PatternFill("solid", fgColor="B91C1C"),    # red-700
            "medium": PatternFill("solid", fgColor="B45309"),  # amber-700
            "low": PatternFill("solid", fgColor="065F46"),     # emerald-800
        }

        # Precompute agency counts per function using Configuration
        # Note: simple per-function query to keep it readable; acceptable for moderate sizes
        for area in areas:
            # Sort functions by criticality then name for consistency with print view
            functions = sorted(
                list(area.functions),
                key=lambda fx: (
                    severity_order.get(getattr(getattr(fx, 'criticality', None), 'value', 'medium'), 1),
                    (fx.name or '').lower(),
                ),
            )
            if not functions:
                # Emit an area line with em dash if no functions yet
                ws.cell(row=row, column=1, value=area.name)
                ws.cell(row=row, column=2, value="—")
                for c in range(1, len(headers) + 1):
                    ws.cell(row=row, column=c).border = border
                row += 1
                continue

            for f in functions:
                # Component count via association
                try:
                    component_count = len(f.components)
                except Exception:
                    component_count = 0
                # Distinct agencies with configurations for this function
                agency_count = db.session.query(
                    func.count(func.distinct(Configuration.agency_id))
                ).filter(Configuration.function_id == f.id).scalar() or 0

                crit_val = getattr(getattr(f, 'criticality', None), 'value', None)
                crit_disp = crit_val.title() if crit_val else None

                ws.cell(row=row, column=1, value=area.name)
                ws.cell(row=row, column=2, value=f.name)
                crit_cell = ws.cell(row=row, column=3, value=crit_disp)
                ws.cell(row=row, column=4, value=component_count)
                ws.cell(row=row, column=5, value=agency_count)

                # Borders and criticality color badges (fill only the crit cell for subtlety)
                for c in range(1, len(headers) + 1):
                    ws.cell(row=row, column=c).border = border
                    if c == 3 and crit_val in crit_fills:
                        ws.cell(row=row, column=c).fill = crit_fills[crit_val]
                        ws.cell(row=row, column=c).font = Font(color="FFFFFF", bold=True)
                        ws.cell(row=row, column=c).alignment = Alignment(horizontal="center")

                row += 1

        # Freeze header and add auto-filter
        ws.freeze_panes = f"A{header_row_idx + 1}"
        ws.auto_filter.ref = f"A{header_row_idx}:" + get_column_letter(len(headers)) + f"{row - 1}"

        # Auto-fit columns
        for col_idx in range(1, len(headers) + 1):
            letter = get_column_letter(col_idx)
            max_len = 0
            for r in range(1, row):
                v = ws.cell(r, col_idx).value
                max_len = max(max_len, len(str(v)) if v is not None else 0)
            ws.column_dimensions[letter].width = min(max_len + 2, 48)

        # Stream workbook to response
        buf = io.BytesIO()
        wb.save(buf)
        buf.seek(0)
        filename = f"functional_areas_{datetime.utcnow().strftime('%Y%m%d_%H%M')}.xlsx"
        return send_file(
            buf,
            as_attachment=True,
            download_name=filename,
            mimetype="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        )
    except Exception as e:
        return json_error_response(f"Error generating export: {str(e)}", 500)

@main.get('/docs')
@login_required
def docs_index():
    import os, glob
    docs_dir = os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(__file__))), 'docs')
    # Collect .md files (exclude hidden) and basic metadata
    files = []
    for path in sorted(glob.glob(os.path.join(docs_dir, '*.md'))):
        name = os.path.basename(path)
        try:
            with open(path, 'r', encoding='utf-8') as f:
                first = ''
                for _ in range(5):
                    line = f.readline()
                    if not line: break
                    if line.strip():
                        first = line.strip().lstrip('# ').strip()
                        break
                title = first or name
        except Exception:
            title = name
        files.append({'filename': name, 'title': title})
    # Default: show first doc
    selected = request.args.get('file') or (files[0]['filename'] if files else None)
    content_html = ''
    if selected:
        sel_path = os.path.join(docs_dir, selected)
        if os.path.isfile(sel_path):
            try:
                import markdown
                with open(sel_path, 'r', encoding='utf-8') as f:
                    raw = f.read()
                content_html = markdown.markdown(raw, extensions=['fenced_code', 'tables', 'toc'])
            except Exception as e:
                content_html = f"<p class='text-red-400 text-sm'>Error rendering: {e}</p>"
        else:
            content_html = "<p class='text-red-400 text-sm'>File not found.</p>"
    return render_template('docs.html', files=files, selected=selected, content_html=content_html)

# Print-friendly grid of all Functional Areas
@main.route("/functional-areas/print")
def functional_areas_print_page():
    try:
        areas = FunctionalArea.query.order_by(FunctionalArea.name.asc()).all()
        return render_template(
            'functional_areas_print.html',
            functional_areas=areas,
            title="Functional Areas – Print"
        )
    except Exception as e:
        # Fallback to empty list with error message embedded in page
        return render_template(
            'functional_areas_print.html',
            functional_areas=[],
            error=str(e),
            title="Functional Areas – Print"
        )

# Print-friendly page listing all functions organized by Functional Area
@main.route("/functions/print")
def functions_print_page():
    try:
        areas = (FunctionalArea.query
                 .options(joinedload(FunctionalArea.functions))
                 .order_by(FunctionalArea.name.asc())
                 .all())

        # decorate each function with quick counts and sort by criticality then name
        severity_order = {'high': 0, 'medium': 1, 'low': 2}
        for area in areas:
            for f in area.functions:
                try:
                    f.component_count = len(f.components)
                except Exception:
                    f.component_count = 0
                # distinct agencies using this function via configurations
                agency_count = db.session.query(func.count(func.distinct(Configuration.agency_id))) \
                    .filter(Configuration.function_id == f.id).scalar() or 0
                f.agency_count = agency_count
            # sorted list for display
            area.sorted_functions = sorted(
                list(area.functions),
                key=lambda fx: (
                    severity_order.get(getattr(getattr(fx, 'criticality', None), 'value', 'medium'), 1),
                    fx.name.lower()
                )
            )

        return render_template(
            'functions_print.html',
            functional_areas=areas,
            title="Functions – Print"
        )
    except Exception as e:
        return render_template(
            'functions_print.html',
            functional_areas=[],
            error=str(e),
            title="Functions – Print"
        )

@main.route('/reports')
def reports_page():
    # lightweight placeholder page
    return render_template('reports.html') if False else render_template('index.html')

@main.route("/components")
def components_page():
    """Components management page"""
    return render_template("components.html")

@main.route("/vendors")
def vendors_page():
    """Vendors management page"""
    return render_template("vendors.html")

# Health and utility endpoints
@main.route("/api/health")
def health_check():
    try:
        # Test database connection
        db.session.execute(db.text('SELECT 1'))
        return jsonify({
            "status": "ok", 
            "timestamp": datetime.utcnow().isoformat(),
            "database": "connected"
        })
    except Exception as e:
        return json_error_response(f"Health check failed: {str(e)}", 500)

# ========== Functional Areas API (CRUD + fragments) ==========

@main.route('/api/functional-areas/list')
def functional_areas_list():
    try:
        search = (request.args.get('search') or '').strip()
        q = FunctionalArea.query
        if search:
            q = q.filter(FunctionalArea.name.ilike(f"%{search}%"))
        areas = q.order_by(FunctionalArea.name.asc()).all()
        return render_template('fragments/functional_area_list.html', functional_areas=areas)
    except Exception as e:
        return html_error_fragment(f"Error loading functional areas: {str(e)}")

@main.route('/api/functional-areas/<int:area_id>/details')
def functional_area_details(area_id):
    try:
        area = FunctionalArea.query.get_or_404(area_id)
        # decorate functions with counts used in template
        for f in area.functions:
            # component count from association
            try:
                f.component_count = len(f.components)
            except Exception:
                f.component_count = 0
            # agency count via configurations
            agency_count = db.session.query(func.count(func.distinct(Configuration.agency_id))) \
                .filter(Configuration.function_id == f.id).scalar() or 0
            f.agency_count = agency_count
        # sort functions by criticality severity then name
        severity_order = {'high': 0, 'medium': 1, 'low': 2}
        area.sorted_functions = sorted(
            list(area.functions),
            key=lambda fx: (severity_order.get(getattr(getattr(fx, 'criticality', None), 'value', 'medium'), 1), fx.name.lower())
        )
        return render_template('fragments/functional_area_details.html', functional_area=area)
    except Exception as e:
        return html_error_fragment(f"Error loading functional area details: {str(e)}")

@main.route('/api/functional-areas/form')
def functional_area_form():
    try:
        return render_template('fragments/functional_area_form.html', functional_area=None)
    except Exception as e:
        return html_error_fragment(f"Error loading form: {str(e)}")

@main.route('/api/functional-areas/<int:area_id>/form')
def functional_area_edit_form(area_id):
    try:
        area = FunctionalArea.query.get_or_404(area_id)
        return render_template('fragments/functional_area_form.html', functional_area=area)
    except Exception as e:
        return html_error_fragment(f"Error loading edit form: {str(e)}")

@main.route('/api/functional-areas', methods=['POST'])
@login_required
def functional_area_create():
    try:
        name = (request.form.get('name') or '').strip()
        description = (request.form.get('description') or '').strip() or None
        if not name:
            return html_error_fragment('Name is required')
        area = FunctionalArea(name=name, description=description)
        db.session.add(area)
        db.session.commit()
        return html_success_fragment('Functional area created')
    except Exception as e:
        db.session.rollback()
        return html_error_fragment(f"Error creating functional area: {str(e)}")

@main.route('/api/functional-areas/<int:area_id>', methods=['PUT'])
@login_required
def functional_area_update(area_id):
    try:
        area = FunctionalArea.query.get_or_404(area_id)
        name = (request.form.get('name') or '').strip()
        description = (request.form.get('description') or '').strip() or None
        if not name:
            return html_error_fragment('Name is required')
        area.name = name
        area.description = description
        db.session.commit()
        return html_success_fragment('Functional area updated')
    except Exception as e:
        db.session.rollback()
        return html_error_fragment(f"Error updating functional area: {str(e)}")

@main.route('/api/functional-areas/<int:area_id>', methods=['DELETE'])
@login_required
def functional_area_delete(area_id):
    try:
        area = FunctionalArea.query.get_or_404(area_id)
        db.session.delete(area)
        db.session.commit()
        return html_success_fragment('Functional area deleted')
    except Exception as e:
        db.session.rollback()
        return html_error_fragment(f"Error deleting functional area: {str(e)}")

# Count endpoints for dashboard metrics
@main.route("/api/count/agencies")
def count_agencies():
    try:
        count = Agency.query.count()
        return str(count)
    except Exception as e:
        return "0"

@main.route("/api/count/functional-areas")
def count_functional_areas():
    try:
        count = FunctionalArea.query.count()
        return str(count)
    except Exception as e:
        return "0"

@main.route("/api/count/components")
def count_components():
    try:
        count = Component.query.count()
        return str(count)
    except Exception as e:
        return "0"

@main.route("/api/count/integration-points")
def count_integration_points():
    try:
        count = IntegrationPoint.query.count()
        return str(count)
    except Exception as e:
        return "0"

@main.route("/api/count/vendors")
def count_vendors():
    try:
        count = Vendor.query.count()
        return str(count)
    except Exception as e:
        return "0"

@main.route("/api/count/configurations")
def count_configurations():
    try:
        return str(Configuration.query.count())
    except Exception:
        return "0"

@main.route("/api/count/products")
def count_products():
    try:
        return str(Product.query.count())
    except Exception:
        return "0"

# Components endpoints
@main.route("/api/components/list")
def components_list():
    """Get all components with filtering (updated to use Configuration instead of AFI)."""
    try:
        functional_area = (request.args.get('functional_area') or '').strip()
        agency = (request.args.get('agency') or '').strip()
        status = (request.args.get('status') or '').strip()
        search = (request.args.get('search') or '').strip()
        # vendor filter removed (Component no longer tied to vendor)
        query = db.session.query(Component).distinct()
        if functional_area:
            query = (query
                     .join(Configuration, Configuration.component_id == Component.id)
                     .join(Function, Function.id == Configuration.function_id)
                     .join(FunctionalArea, FunctionalArea.id == Function.functional_area_id)
                     .filter(FunctionalArea.name == functional_area))
        if agency:
            query = (query
                     .join(Configuration, Configuration.component_id == Component.id)
                     .join(Agency, Agency.id == Configuration.agency_id)
                     .filter(Agency.name == agency))
        if status:
            query = (query
                     .join(Configuration, Configuration.component_id == Component.id)
                     .filter(Configuration.status == status))
        if search:
            name_like = f"%{search}%"
            query = query.filter(Component.name.ilike(name_like))
        query = query.order_by(Component.name.asc())
        components = query.all()
        view_components = []
        for component in components:
            agencies_using = (db.session.query(Agency.name)
                              .join(Configuration, Configuration.agency_id == Agency.id)
                              .filter(Configuration.component_id == component.id)
                              .distinct().limit(3).all())
            agencies_display = ", ".join([a.name for a in agencies_using]) or 'No agencies'
            if len(agencies_using) == 3:
                agencies_display += ' +more'
            functions_implemented = (db.session.query(Function.name)
                                     .join(Configuration, Configuration.function_id == Function.id)
                                     .filter(Configuration.component_id == component.id)
                                     .distinct().limit(3).all())
            functions_display = ", ".join([f.name for f in functions_implemented]) or 'No functions'
            if len(functions_implemented) == 3:
                functions_display += ' +more'
            # NEW: latest configuration version label & deployment date (for display on card)
            latest_cfg = (Configuration.query
                          .filter(Configuration.component_id == component.id)
                          .order_by(Configuration.deployment_date.desc().nullslast(), Configuration.updated_at.desc())
                          .first())
            version_label = getattr(latest_cfg, 'version_label', None) if latest_cfg else None
            deployment_date_str = ''
            if latest_cfg and latest_cfg.deployment_date:
                try:
                    deployment_date_str = latest_cfg.deployment_date.strftime('%Y-%m-%d')
                except Exception:
                    deployment_date_str = ''
            view_components.append(type('VC', (), {
                'id': component.id,
                'name': component.name,
                'is_composite': False,
                'status_indicator': 'green',
                'functions_display': functions_display,
                'vendor_name': '—',
                'agencies_display': agencies_display,
                'deployment_date_str': deployment_date_str,
                'version': version_label,  # keep legacy usage
                'version_label': version_label,
                'known_issues': None,
                'short_description': component.short_description,
            }))
        return render_template('fragments/component_list.html', components=view_components)
    except Exception as e:
        return html_error_fragment(f"Error loading components: {str(e)}")

@main.route("/api/components/<int:component_id>/details")
def component_details(component_id):
    """Updated component details using Configurations."""
    try:
        component = Component.query.get_or_404(component_id)
        configurations = (Configuration.query
                          .filter_by(component_id=component_id)
                          .join(Agency).join(Function).join(FunctionalArea)
                          .order_by(Agency.name, FunctionalArea.name, Function.name)
                          .all())
        agency_usage_html = ""
        if configurations:
            agency_usage_html = "<h4 class='font-medium text-white mb-3'>Agency Usage:</h4>"
            agencies = {}
            for c in configurations:
                agencies.setdefault(c.agency.name, []).append(c)
            for agency_name, cfgs in agencies.items():
                agency_usage_html += f'''<div class="mb-4"><h5 class="text-sm font-medium text-blue-400 mb-2">{agency_name}</h5><div class="space-y-2 ml-3">'''
                for cfg in cfgs:
                    status_color = "green" if cfg.status == "Active" else "yellow"
                    agency_usage_html += f'''<div class="flex items-center justify-between p-2 bg-slate-700/30 rounded"><div class="flex items-center space-x-2"><div class="w-2 h-2 bg-{status_color}-500 rounded-full"></div><span class="text-sm text-slate-300">{cfg.function.name}</span></div><div class="text-right"><span class="text-xs text-slate-500">{cfg.deployment_date.strftime('%Y-%m-%d') if cfg.deployment_date else 'No date'}</span>{f'<br><span class="text-xs text-slate-400">{cfg.version_label}</span>' if cfg.version_label else ''}</div></div>'''
                agency_usage_html += "</div></div>"
        else:
            agency_usage_html = "<p class='text-slate-400 text-sm'>No configuration usage tracked for this component.</p>"
        roles = ""
        if component.user_roles:
            roles = "<h4 class='font-medium text-white mb-2 mt-4'>User Roles:</h4><ul class='space-y-1'>" + \
                "".join([f'<li class="text-sm text-slate-300">• {r.role_name}: {r.description or "No description"}</li>' for r in component.user_roles]) + "</ul>"
        metadata = ""
        if component.additional_metadata:
            metadata = "<h4 class='font-medium text-white mb-2 mt-4'>Additional Information:</h4><ul class='space-y-1'>" + \
                "".join([f'<li class="text-sm text-slate-300">• {k.replace("_"," ").title()}: {v}</li>' for k,v in component.additional_metadata.items()]) + "</ul>"
        # NEW: include short_description and description
        short_desc_html = f"<p class='text-slate-300 mt-1'>{component.short_description}</p>" if getattr(component, 'short_description', None) else ""
        description_html = f"<div class='mt-4'><h3 class='font-medium text-white mb-2'>Description</h3><p class='text-slate-300 text-sm'>{component.description}</p></div>" if getattr(component, 'description', None) else ""
        html = f'''<div class="glass-effect rounded-xl p-6 border border-slate-700/50"><div class="flex items-center justify-between mb-4"><div class="flex items-center space-x-3"><h2 class="text-2xl font-bold text-white">{component.name}</h2></div><button class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm transition-colors" onclick="clearComponentDetails()">✕ Close</button></div><div class="grid grid-cols-1 gap-6"><div><div class="space-y-2 text-sm">{short_desc_html}</div>{description_html}<div class="mt-6">{agency_usage_html}</div>{roles}{metadata}</div></div></div>'''
        return html
    except Exception as e:
        return html_error_fragment(f"Error loading component details: {str(e)}")

@main.route("/api/agencies/options")
def agencies_filter_options():
    """Get agency options for filter dropdowns (based on Configurations now)."""
    try:
        agencies = (db.session.query(Agency.name)
                    .join(Configuration, Configuration.agency_id == Agency.id)
                    .distinct()
                    .order_by(Agency.name)
                    .all())
        html = '<option value="">All Agencies</option>'
        for agency in agencies:
            html += f'<option value="{agency.name}">{agency.name}</option>'
        return html
    except Exception as e:
        return html_error_fragment(f"Error loading agency options: {str(e)}")

@main.route("/api/filter-options/functional-areas")
def functional_area_filter_options():
    """HTMX: functional area options (derived from active Configuration usage)."""
    try:
        fa_rows = (db.session.query(FunctionalArea.name)
                   .join(Function, Function.functional_area_id == FunctionalArea.id)
                   .join(Configuration, Configuration.function_id == Function.id)
                   .distinct()
                   .order_by(FunctionalArea.name)
                   .all())
        html = '<option value="">All Functional Areas</option>'
        for fa in fa_rows:
            html += f'<option value="{fa.name}">{fa.name}</option>'
        return html
    except Exception as e:
        return html_error_fragment(f"Error loading functional areas: {str(e)}")

@main.route('/api/vendors/filter-options/functional-areas')
def vendors_functional_area_filter_options():
    """Alias for vendors page expecting this endpoint."""
    return functional_area_filter_options()

@main.route('/api/vendors/filter-options/agencies')
def vendors_agency_filter_options():
    """Alias endpoint for vendor page to load agency options."""
    return agencies_filter_options()


@main.route('/api/integration/standards')
def integration_standards_list():
    """HTML fragment: list integration standards with simple usage counts (placeholder logic)."""
    try:
        # Basic list ordered by name; extend with real metrics later
        standards = Standard.query.order_by(Standard.name.asc()).all()
        if not standards:
            return '<p class="text-slate-500 text-sm">No standards defined.</p>'
        html_parts = []
        for s in standards:
            html_parts.append(f"<div class='flex items-center justify-between p-2 bg-slate-800/40 rounded text-sm'><span class='text-slate-300'>{s.name}</span></div>")
        return "\n".join(html_parts)
    except Exception as e:
        return html_error_fragment(f"Error loading standards: {str(e)}")

# -------- COMPONENT FORMS (vendor removed) ----------
@main.route("/api/components/form")
@login_required
def component_form():
    try:
        form = ComponentForm()
        return render_template('fragments/component_form.html', form=form, component=None)
    except Exception as e:
        return html_error_fragment(f"Error loading component form: {str(e)}")

@main.route("/api/components/<int:component_id>/form")
@login_required
def component_edit_form(component_id):
    try:
        component = Component.query.get_or_404(component_id)
        form = ComponentForm()
        form.populate_from_component(component)
        return render_template('fragments/component_form.html', form=form, component=component)
    except Exception as e:
        return html_error_fragment(f"Error loading component edit form: {str(e)}")

# NEW: Component create/update/delete endpoints
@main.route("/api/components", methods=['POST'])
@login_required
def component_create():
    form = ComponentForm()
    if form.validate_on_submit():
        try:
            c = Component()
            form.populate_component(c)
            db.session.add(c)
            db.session.commit()
            return json_success_response(f"Component '{c.name}' created", data={"id": c.id})
        except IntegrityError as ie:
            db.session.rollback()
            return json_error_response(f"Error creating component: {str(ie)}")
        except Exception as e:
            db.session.rollback()
            return json_error_response(f"Error creating component: {str(e)}")
    return json_form_error_response(form)

@main.route("/api/components/<int:component_id>", methods=['POST'])
@login_required
def component_update(component_id):
    component = Component.query.get_or_404(component_id)
    form = ComponentForm()
    if form.validate_on_submit():
        try:
            form.populate_component(component)
            db.session.commit()
            return json_success_response(f"Component '{component.name}' updated", data={"id": component.id})
        except Exception as e:
            db.session.rollback()
            return json_error_response(f"Error updating component: {str(e)}")
    return json_form_error_response(form)

@main.route("/api/components/<int:component_id>", methods=['DELETE'])
@login_required
def component_delete(component_id):
    try:
        component = Component.query.get_or_404(component_id)
        # Prevent deletion if used in any configuration
        in_use = Configuration.query.filter_by(component_id=component_id).first() is not None
        if in_use:
            return json_error_response("Cannot delete component – it is referenced by one or more configurations.")
        db.session.delete(component)
        db.session.commit()
        return json_success_response("Component deleted successfully")
    except Exception as e:
        db.session.rollback()
        return json_error_response(f"Error deleting component: {str(e)}")

# -------- VENDORS LIST (repoint to Products & ConfigurationProduct) ----------
@main.route("/api/vendors/list")
def vendors_list():
    """Vendors list using product & configuration usage metrics."""
    try:
        search = request.args.get('search', '').strip()
        agency_filter = request.args.get('agency', '').strip()
        functional_area_filter = request.args.get('functional_area', '').strip()
        sort_by = request.args.get('sort', 'name')

        product_sub = db.session.query(
            Product.vendor_id.label('v_id'),
            func.count(Product.id).label('product_count')
        ).group_by(Product.vendor_id).subquery()

        usage_sub = db.session.query(
            Product.vendor_id.label('v_id'),
            func.count(func.distinct(Configuration.id)).label('usage_count')
        ).join(ConfigurationProduct, ConfigurationProduct.product_id == Product.id) \
         .join(Configuration, Configuration.id == ConfigurationProduct.configuration_id) \
         .group_by(Product.vendor_id).subquery()

        q = db.session.query(
            Vendor,
            func.coalesce(product_sub.c.product_count, 0).label('product_count'),
            func.coalesce(usage_sub.c.usage_count, 0).label('usage_count')
        ).outerjoin(product_sub, product_sub.c.v_id == Vendor.id) \
         .outerjoin(usage_sub, usage_sub.c.v_id == Vendor.id)

        if agency_filter or functional_area_filter:
            usage_filter_query = db.session.query(func.distinct(Vendor.id)) \
                .join(Product, Product.vendor_id == Vendor.id) \
                .join(ConfigurationProduct, ConfigurationProduct.product_id == Product.id) \
                .join(Configuration, Configuration.id == ConfigurationProduct.configuration_id)
            if agency_filter:
                usage_filter_query = usage_filter_query.join(Agency, Agency.id == Configuration.agency_id) \
                    .filter(Agency.name == agency_filter)
            if functional_area_filter:
                usage_filter_query = usage_filter_query.join(Function, Function.id == Configuration.function_id) \
                    .join(FunctionalArea, FunctionalArea.id == Function.functional_area_id) \
                    .filter(FunctionalArea.name == functional_area_filter)
            vendor_ids = [vid[0] for vid in usage_filter_query.all()]
            if vendor_ids:
                q = q.filter(Vendor.id.in_(vendor_ids))
            else:
                q = q.filter(db.text("1=0"))

        if search:
            q = q.filter(Vendor.name.ilike(f'%{search}%'))

        if sort_by in ('components', 'products'):
            q = q.order_by(func.coalesce(product_sub.c.product_count, 0).desc(), Vendor.name.asc())
        elif sort_by == 'recent':
            pv_sub = db.session.query(
                Product.vendor_id.label('v_id'),
                func.max(ProductVersion.release_date).label('latest_release')
            ).join(ProductVersion, ProductVersion.product_id == Product.id) \
             .group_by(Product.vendor_id).subquery()
            q = q.outerjoin(pv_sub, pv_sub.c.v_id == Vendor.id) \
                 .order_by(pv_sub.c.latest_release.desc().nullslast(), Vendor.name.asc())
        else:
            q = q.order_by(Vendor.name.asc())

        rows = q.all()
        for vendor, product_count, usage_count in rows:
            vendor.product_count = product_count
            vendor.usage_count = usage_count
        return render_template('fragments/vendor_list.html', vendors_with_counts=rows)
    except Exception as e:
        return html_error_fragment(f"Error loading vendors: {str(e)}")

# -------- VENDOR DETAILS (repoint) ----------
@main.route("/api/vendors/<int:vendor_id>/details")
def vendor_details(vendor_id):
    """Vendor detail using Products + usage via ConfigurationProduct."""
    try:
        vendor = Vendor.query.get_or_404(vendor_id)
        area_map = {}
        usage_rows = db.session.query(
            Product.id, Product.name,
            FunctionalArea.name.label('fa_name')
        ).join(ConfigurationProduct, ConfigurationProduct.product_id == Product.id) \
         .join(Configuration, Configuration.id == ConfigurationProduct.configuration_id) \
         .join(Function, Function.id == Configuration.function_id) \
         .join(FunctionalArea, FunctionalArea.id == Function.functional_area_id) \
         .filter(Product.vendor_id == vendor_id) \
         .distinct().all()
        used_product_ids = set()
        for pid, pname, fa_name in usage_rows:
            area_map.setdefault(fa_name, []).append((pid, pname))
            used_product_ids.add(pid)
        unused_products = Product.query.filter(Product.vendor_id == vendor_id, ~Product.id.in_(used_product_ids)).all()
        if unused_products:
            area_map.setdefault('Unassigned', []).extend([(p.id, p.name) for p in unused_products])
        versions_q = db.session.query(ProductVersion).join(Product).filter(Product.vendor_id == vendor_id)
        total_versions = versions_q.count()
        eol_soon = versions_q.filter(
            ProductVersion.support_end_date.isnot(None),
            ProductVersion.support_end_date <= func.date(func.now(), '+90 day')
        ).count()
        vendor.products_by_area = {k: [pn for _, pn in v] for k, v in area_map.items()}
        vendor.total_products = Product.query.filter_by(vendor_id=vendor_id).count()
        vendor.active_usage = db.session.query(func.count(func.distinct(Configuration.id))) \
            .join(ConfigurationProduct, ConfigurationProduct.configuration_id == Configuration.id) \
            .join(Product, Product.id == ConfigurationProduct.product_id) \
            .filter(Product.vendor_id == vendor_id).scalar()
        vendor.total_versions = total_versions
        vendor.eol_soon_versions = eol_soon
        return render_template('fragments/vendor_details.html', vendor=vendor)
    except Exception as e:
        return html_error_fragment(f"Error loading vendor details: {str(e)}")

# -------- VENDOR FORMS ----------
@main.route("/api/vendors/form")
def vendor_form():
    try:
        form = VendorForm()
        return render_template('fragments/vendor_form.html', form=form, vendor=None)
    except Exception as e:
        return html_error_fragment(f"Error loading form: {str(e)}")

@main.route("/api/vendors/<int:vendor_id>/form")
def vendor_edit_form(vendor_id):
    try:
        vendor = Vendor.query.get_or_404(vendor_id)
        form = VendorForm()
        form.populate_from_vendor(vendor)
        return render_template('fragments/vendor_form.html', form=form, vendor=vendor)
    except Exception as e:
        return html_error_fragment(f"Error loading edit form: {str(e)}")

# -------- VENDOR DELETE (guard on product & usage) ----------
@main.route("/api/vendors/<int:vendor_id>", methods=['DELETE'])
@login_required
def delete_vendor(vendor_id):
    try:
        vendor = Vendor.query.get_or_404(vendor_id)
        name = vendor.name
        usage_exists = db.session.query(ConfigurationProduct.id) \
            .join(Product, Product.id == ConfigurationProduct.product_id) \
            .filter(Product.vendor_id == vendor_id).first()
        if usage_exists:
            return json_error_response(f"Cannot delete vendor '{name}' – products in active configurations.")
        product_count = Product.query.filter_by(vendor_id=vendor_id).count()
        if product_count > 0:
            return json_error_response(
                f"Cannot delete vendor '{name}' because it still has {product_count} products. Delete or reassign products first."
            )
        db.session.delete(vendor)
        db.session.commit()
        return json_success_response(f"Vendor '{name}' deleted successfully")
    except Exception as e:
        db.session.rollback()
        return json_error_response(f"Error deleting vendor: {str(e)}")

# -------- VENDOR STATS (repoint) ----------
@main.route("/api/vendors/stats")
def vendors_stats():
    """Aggregate vendor statistics using products + configuration usage."""
    try:
        total_vendors = Vendor.query.count()
        total_products = Product.query.count()
        vendors_with_usage = db.session.query(func.count(func.distinct(Vendor.id))) \
            .join(Product, Product.vendor_id == Vendor.id) \
            .join(ConfigurationProduct, ConfigurationProduct.product_id == Product.id) \
            .join(Configuration, Configuration.id == ConfigurationProduct.configuration_id).scalar()
        avg_products_per_vendor = round(total_products / total_vendors, 1) if total_vendors else 0
        most_used = db.session.query(
            Vendor.name,
            func.count(func.distinct(Configuration.id)).label('cfg_use')
        ).join(Product, Product.vendor_id == Vendor.id) \
         .join(ConfigurationProduct, ConfigurationProduct.product_id == Product.id) \
         .join(Configuration, Configuration.id == ConfigurationProduct.configuration_id) \
         .group_by(Vendor.id, Vendor.name) \
         .order_by(func.count(func.distinct(Configuration.id)).desc()) \
         .first()
        stats = {
            'total_vendors': total_vendors,
            'vendors_with_usage': vendors_with_usage or 0,
            'avg_products_per_vendor': avg_products_per_vendor,
            'most_used_vendor': most_used.name if most_used else 'N/A',
            'most_used_vendor_cfgs': most_used.cfg_use if most_used else 0
        }
        return jsonify(stats)
    except Exception as e:
        return json_error_response(f"Error getting vendor stats: {str(e)}")

# -------- VENDOR PERFORMANCE (new metrics) ----------
@main.route("/api/vendors/performance")
def vendor_performance():
    """Vendor performance metrics based on product versions & usage."""
    try:
        most_versions = db.session.query(
            Vendor.name,
            func.count(ProductVersion.id).label('ver_count')
        ).join(Product, Product.vendor_id == Vendor.id) \
         .join(ProductVersion, ProductVersion.product_id == Product.id) \
         .group_by(Vendor.id, Vendor.name) \
         .order_by(func.count(ProductVersion.id).desc()) \
         .first()
        recent_release = db.session.query(
            Vendor.name,
            func.max(ProductVersion.release_date).label('latest_release')
        ).join(Product, Product.vendor_id == Vendor.id) \
         .join(ProductVersion, ProductVersion.product_id == Product.id) \
         .group_by(Vendor.id, Vendor.name) \
         .order_by(func.max(ProductVersion.release_date).desc().nullslast()) \
         .first()
        most_used = db.session.query(
            Vendor.name,
            func.count(func.distinct(Configuration.id)).label('cfg_use')
        ).join(Product, Product.vendor_id == Vendor.id) \
         .join(ConfigurationProduct, ConfigurationProduct.product_id == Product.id) \
         .join(Configuration, Configuration.id == ConfigurationProduct.configuration_id) \
         .group_by(Vendor.id, Vendor.name) \
         .order_by(func.count(func.distinct(Configuration.id)).desc()) \
         .first()
        return jsonify({
            'most_versions': most_versions.name if most_versions else 'N/A',
            'most_versions_count': most_versions.ver_count if most_versions else 0,
            'most_recent_release_vendor': recent_release.name if recent_release else 'N/A',
            'most_recent_release_date': recent_release.latest_release.isoformat() if (recent_release and recent_release.latest_release) else None,
            'most_used_vendor': most_used.name if most_used else 'N/A',
            'most_used_vendor_cfgs': most_used.cfg_use if most_used else 0
        })
    except Exception as e:
        return json_error_response(f"Error getting vendor performance: {str(e)}")

# -------- AGENCIES LIST (new endpoint) ----------
@main.route("/api/agencies/list")
def agencies_list_fragment():
    """HTMX fragment: agencies list with synthetic implementation counts from Configurations."""
    try:
        search = (request.args.get('search') or '').strip()
        # Subquery for configuration counts per agency
        cfg_sub = db.session.query(
            Configuration.agency_id.label('a_id'),
            func.count(Configuration.id).label('cfg_count')
        ).group_by(Configuration.agency_id).subquery()
        q = db.session.query(Agency, func.coalesce(cfg_sub.c.cfg_count, 0).label('cfg_count')) \
            .outerjoin(cfg_sub, cfg_sub.c.a_id == Agency.id)
        if search:
            q = q.filter(Agency.name.ilike(f"%{search}%"))
        agencies = q.order_by(Agency.name.asc()).all()
        # Attach synthetic attribute used by legacy template (function_implementations|length)
        result = []
        for agency, cfg_count in agencies:
            agency.function_implementations = [None] * cfg_count  # length drives display
            result.append(agency)
        return render_template('fragments/agency_list.html', agencies=result)
    except Exception as e:
        return html_error_fragment(f"Error loading agencies: {str(e)}")

@main.route("/api/agencies/stats")
def agencies_stats():
    """Aggregate agency stats using Configuration model (keeps legacy key names)."""
    try:
        total_agencies = Agency.query.count()
        active_cfgs = Configuration.query.count()
        avg_impl = round(active_cfgs / total_agencies, 1) if total_agencies else 0
        # Average vendors per agency (vendors whose products appear in that agency's configurations)
        vendor_counts_rows = db.session.query(
            Configuration.agency_id,
            func.count(func.distinct(Vendor.id)).label('v_count')
        ).join(ConfigurationProduct, ConfigurationProduct.configuration_id == Configuration.id) \
         .join(Product, Product.id == ConfigurationProduct.product_id) \
         .join(Vendor, Vendor.id == Product.vendor_id) \
         .group_by(Configuration.agency_id).all()
        avg_vendors = round(sum(r.v_count for r in vendor_counts_rows) / len(vendor_counts_rows), 1) if vendor_counts_rows else 0
        return jsonify({
            'active_implementations': active_cfgs,
            'avg_implementations_per_agency': avg_impl,
            'avg_vendors_per_agency': avg_vendors
        })
    except Exception as e:
        return json_error_response(f"Error getting agency stats: {str(e)}")

@main.route("/api/agencies/insights")
def agencies_insights():
    """Insights: tech leader (most configurations), common functional area, top vendor."""
    try:
        tech_leader = db.session.query(
            Agency.name, func.count(Configuration.id).label('cfg_count')
        ).join(Configuration, Configuration.agency_id == Agency.id) \
         .group_by(Agency.id).order_by(func.count(Configuration.id).desc()).first()
        common_area = db.session.query(
            FunctionalArea.name, func.count(Configuration.id).label('cfg_count')
        ).join(Function, Function.functional_area_id == FunctionalArea.id) \
         .join(Configuration, Configuration.function_id == Function.id) \
         .group_by(FunctionalArea.id).order_by(func.count(Configuration.id).desc()).first()
        top_vendor = db.session.query(
            Vendor.name, func.count(func.distinct(Configuration.id)).label('cfg_use')
        ).join(Product, Product.vendor_id == Vendor.id) \
         .join(ConfigurationProduct, ConfigurationProduct.product_id == Product.id) \
         .join(Configuration, Configuration.id == ConfigurationProduct.configuration_id) \
         .group_by(Vendor.id).order_by(func.count(func.distinct(Configuration.id)).desc()).first()
        return jsonify({
            'tech_leader': tech_leader.name if tech_leader else 'N/A',
            'common_area': common_area.name if common_area else 'N/A',
            'top_vendor': top_vendor.name if top_vendor else 'N/A'
        })
    except Exception as e:
        return json_error_response(f"Error getting agency insights: {str(e)}")

@main.route("/api/agencies/<int:agency_id>/details")
def agency_details_fragment(agency_id):
    """HTMX fragment: agency details panel (adapts to legacy template expectations)."""
    try:
        agency = Agency.query.get_or_404(agency_id)
        cfg_count = db.session.query(func.count(Configuration.id)).filter(Configuration.agency_id == agency_id).scalar()
        agency.function_implementations = [None] * cfg_count
        return render_template('fragments/agency_details.html', agency=agency)
    except Exception as e:
        return html_error_fragment(f"Error loading agency details: {str(e)}")

@main.route("/api/agencies/form")
def agency_form_fragment():
    try:
        form = AgencyForm()
        return render_template('fragments/agency_form.html', form=form, agency=None)
    except Exception as e:
        return html_error_fragment(f"Error loading agency form: {str(e)}")

@main.route("/api/agencies/<int:agency_id>/form")
def agency_edit_form_fragment(agency_id):
    try:
        agency = Agency.query.get_or_404(agency_id)
        form = AgencyForm()
        form.populate_agency(agency)
        return render_template('fragments/agency_form.html', form=form, agency=agency)
    except Exception as e:
        return html_error_fragment(f"Error loading agency edit form: {str(e)}")

@main.route('/agencies/<int:agency_id>/update', methods=['POST'])
def update_agency(agency_id):
    """Handle agency edit form submission (non-AJAX)."""
    agency = Agency.query.get_or_404(agency_id)
    form = AgencyForm()
    if form.validate_on_submit():
        try:
            form.populate_agency(agency)
            agency.short_name = request.form.get('short_name') or None
            db.session.commit()
            return redirect(url_for('agency.index'))
        except Exception as e:
            db.session.rollback()
            return html_error_fragment(f"Error updating agency: {str(e)}")
    # If validation fails re-render form fragment
    return render_template('fragments/agency_form.html', form=form, agency=agency)

@main.route("/api/vendors", methods=['POST'])
@login_required
def create_vendor():
    """Create a new vendor (JSON response for HTMX form)."""
    form = VendorForm()
    if form.validate_on_submit():
        try:
            vendor = Vendor()
            form.populate_vendor(vendor)
            db.session.add(vendor)
            db.session.commit()
            return json_success_response(f"Vendor '{vendor.name}' created", data={"id": vendor.id})
        except IntegrityError as ie:
            db.session.rollback()
            return json_validation_error_response("Duplicate vendor", {"name": "A vendor with this name already exists."})
        except Exception as e:
            db.session.rollback()
            return json_error_response(f"Error creating vendor: {str(e)}")
    return json_form_error_response(form)


@main.route("/api/vendors/<int:vendor_id>", methods=['POST'])
@login_required
def update_vendor(vendor_id):
    """Update an existing vendor (JSON response for HTMX form)."""
    vendor = Vendor.query.get_or_404(vendor_id)
    form = VendorForm()
    if form.validate_on_submit():
        try:
            form.populate_vendor(vendor)
            db.session.commit()
            return json_success_response(f"Vendor '{vendor.name}' updated", data={"id": vendor.id})
        except IntegrityError:
            db.session.rollback()
            return json_validation_error_response("Duplicate vendor", {"name": "A vendor with this name already exists."})
        except Exception as e:
            db.session.rollback()
            return json_error_response(f"Error updating vendor: {str(e)}")
    return json_form_error_response(form)

# End of app/routes/main.py

# Start of app/routes/agency.py
from flask import Blueprint, render_template, redirect, url_for, flash, request, jsonify
from app import db
from app.models.tran import Agency, Configuration, ConfigurationProduct, Product, Vendor, Function, FunctionalArea
from app.forms.forms import AgencyForm
from sqlalchemy import func

agency_bp = Blueprint('agency', __name__, url_prefix='/agencies')

@agency_bp.route('/')
@agency_bp.route('/<int:page>/', methods=['GET'])
def index(page=1):
    per_page = 10
    agencies = Agency.query.paginate(page=page, per_page=per_page, error_out=False)
    return render_template('agencies.html', agencies=agencies)

# ---------- API: list (fragment) ----------
@agency_bp.route('/api/agencies/list')
def api_agencies_list():
    search = (request.args.get('search') or '').strip()
    q = Agency.query
    if search:
        q = q.filter(Agency.name.ilike(f"%{search}%"))
    agencies = q.order_by(Agency.name.asc()).all()
    return render_template('fragments/agency_list.html', agencies=agencies)

# ---------- API: stats ----------
@agency_bp.route('/api/agencies/stats')
def api_agencies_stats():
    total_agencies = Agency.query.count()
    active_cfgs = Configuration.query.count()
    avg_impl = round(active_cfgs / total_agencies, 1) if total_agencies else 0
    # Vendors per agency via products used in configurations
    # Count distinct vendor per agency, then average
    vendor_counts = db.session.query(
        Configuration.agency_id, func.count(func.distinct(Vendor.id)).label('v_count')
    ).join(ConfigurationProduct, ConfigurationProduct.configuration_id == Configuration.id)
    vendor_counts = vendor_counts.join(Product, Product.id == ConfigurationProduct.product_id)
    vendor_counts = vendor_counts.join(Vendor, Vendor.id == Product.vendor_id)
    vendor_counts = vendor_counts.group_by(Configuration.agency_id).all()
    avg_vendors = 0
    if vendor_counts:
        avg_vendors = round(sum(vc.v_count for vc in vendor_counts) / len(vendor_counts), 1)
    return jsonify({
        'active_implementations': active_cfgs,  # keep legacy key name
        'avg_implementations_per_agency': avg_impl,
        'avg_vendors_per_agency': avg_vendors
    })

# ---------- API: insights ----------
@agency_bp.route('/api/agencies/insights')
def api_agencies_insights():
    # Tech leader: agency with most configurations
    tech_leader_row = db.session.query(
        Agency.name, func.count(Configuration.id).label('cfg_count')
    ).join(Configuration, Configuration.agency_id == Agency.id)
    tech_leader_row = tech_leader_row.group_by(Agency.id).order_by(func.count(Configuration.id).desc()).first()

    # Common area: functional area most represented in configurations
    area_row = db.session.query(
        FunctionalArea.name, func.count(Configuration.id).label('cfg_count')
    ).join(Function, Function.functional_area_id == FunctionalArea.id)
    area_row = area_row.join(Configuration, Configuration.function_id == Function.id)
    area_row = area_row.group_by(FunctionalArea.id).order_by(func.count(Configuration.id).desc()).first()

    # Top vendor: vendor whose products appear in most configurations
    top_vendor_row = db.session.query(
        Vendor.name, func.count(func.distinct(Configuration.id)).label('cfg_use')
    ).join(Product, Product.vendor_id == Vendor.id)
    top_vendor_row = top_vendor_row.join(ConfigurationProduct, ConfigurationProduct.product_id == Product.id)
    top_vendor_row = top_vendor_row.join(Configuration, Configuration.id == ConfigurationProduct.configuration_id)
    top_vendor_row = top_vendor_row.group_by(Vendor.id).order_by(func.count(func.distinct(Configuration.id)).desc()).first()

    return jsonify({
        'tech_leader': tech_leader_row.name if tech_leader_row else 'N/A',
        'common_area': area_row.name if area_row else 'N/A',
        'top_vendor': top_vendor_row.name if top_vendor_row else 'N/A'
    })

# ---------- API: details (fragment) ----------
@agency_bp.route('/api/agencies/<int:agency_id>/details')
def api_agency_details(agency_id):
    agency = Agency.query.get_or_404(agency_id)
    # Compute basic configuration usage summary
    cfg_count = db.session.query(func.count(Configuration.id)).filter(Configuration.agency_id == agency_id).scalar()
    # Top functional areas for this agency
    area_rows = db.session.query(
        FunctionalArea.name, func.count(Configuration.id).label('cfg_count')
    ).join(Function, Function.functional_area_id == FunctionalArea.id)
    area_rows = area_rows.join(Configuration, Configuration.function_id == Function.id)
    area_rows = area_rows.filter(Configuration.agency_id == agency_id)
    area_rows = area_rows.group_by(FunctionalArea.id).order_by(func.count(Configuration.id).desc()).limit(5).all()
    areas = [{'name': r.name, 'count': r.cfg_count} for r in area_rows]
    return render_template('fragments/agency_details.html', agency=agency, cfg_count=cfg_count, top_areas=areas)

# ---------- API: form (fragment) ----------
@agency_bp.route('/api/agencies/form')
def api_agency_form():
    form = AgencyForm()
    return render_template('fragments/agency_form.html', form=form, agency=None)

@agency_bp.route('/api/agencies/<int:agency_id>/form')
def api_agency_edit_form(agency_id):
    agency = Agency.query.get_or_404(agency_id)
    form = AgencyForm()
    form.populate_agency(agency)
    return render_template('fragments/agency_form.html', form=form, agency=agency)

# ---------- API: create/update ----------
@agency_bp.route('/api/agencies', methods=['POST'])
def api_create_agency():
    form = AgencyForm()
    if form.validate_on_submit():
        agency = Agency()
        form.populate_agency(agency)
        agency.short_name = request.form.get('short_name') or None
        db.session.add(agency)
        db.session.commit()
        return jsonify({'status': 'success', 'id': agency.id})
    return jsonify({'status': 'error', 'errors': form.errors}), 400

@agency_bp.route('/api/agencies/<int:agency_id>', methods=['POST'])
def api_update_agency(agency_id):
    agency = Agency.query.get_or_404(agency_id)
    form = AgencyForm()
    if form.validate_on_submit():
        form.populate_agency(agency)
        agency.short_name = request.form.get('short_name') or None
        db.session.commit()
        return jsonify({'status': 'success'})
    return jsonify({'status': 'error', 'errors': form.errors}), 400

# End of app/routes/agency.py

# Start of app/routes/integrations.py
from flask import Blueprint, render_template, request, redirect, url_for

integration_bp = Blueprint('integrations', __name__, url_prefix='/integrations')

@integration_bp.route('/', methods=['GET'])
def list_integrations():
    # TODO: Fetch and display agency integrations
    return render_template('integrations.html', integrations=[])

@integration_bp.route('/new', methods=['GET', 'POST'])
def new_integration():
    if request.method == 'POST':
        # TODO: Process and create a new integration
        name = request.form.get('name')
        description = request.form.get('description')
        # Integration creation logic goes here
        
        return redirect(url_for('integrations.list_integrations'))
    return render_template('integration_form.html')

@integration_bp.route('/standards', methods=['GET', 'POST'])
def manage_standards():
    if request.method == 'POST':
        # TODO: Process new integration standard submission
        standard_name = request.form.get('standard_name')
        # Logic to save the new standard goes here
        
        return redirect(url_for('integrations.list_integrations'))
    return render_template('standards.html')

# End of app/routes/integrations.py

# Start of app/routes/configurations.py
# app/routes/configurations.py
import csv
from io import StringIO
from flask import Blueprint, render_template, request, jsonify, Response
from app import db
from app.auth import login_required, get_updated_by
from app.models.tran import (
    Configuration, ConfigurationHistory, ConfigurationProduct,
    Product, ProductVersion, Agency, Function, Component, Vendor, FunctionalArea
)
from app.forms.forms import (
    ConfigurationForm, ConfigurationProductForm, ProductForm, ProductVersionForm
)
from sqlalchemy.orm import joinedload
from datetime import datetime

config_bp = Blueprint('configurations', __name__)

# --------- Helper / Advisory Stub ---------

def advisory_validate(configuration: Configuration, products):
    """Return non-blocking advisory warning dicts (stub)."""
    warnings = []
    # Placeholder examples
    # warnings.append({"code": "EOL_VERSION", "message": "One product version near end-of-life."})
    return warnings

# Helper: parse product_ids from args or form (supports repeated params and comma-separated)
def _parse_product_ids(arg_source) -> list[int]:
    ids: list[int] = []
    if hasattr(arg_source, 'getlist'):
        raw_list = arg_source.getlist('product_ids')
    else:
        raw_list = []
    # Also support comma-separated single value
    raw_single = arg_source.get('product_ids') if hasattr(arg_source, 'get') else None
    if raw_single and isinstance(raw_single, str) and ',' in raw_single:
        raw_list.extend(raw_single.split(','))
    elif raw_single and not raw_list:
        raw_list.append(raw_single)
    # Normalize & dedupe
    for pid in raw_list:
        try:
            pid_int = int(str(pid).strip())
            ids.append(pid_int)
        except (TypeError, ValueError):
            continue
    # unique preserve order
    seen = set()
    result = []
    for i in ids:
        if i not in seen:
            seen.add(i)
            result.append(i)
    return result

# --------- Pages ---------

@config_bp.route('/configurations')
@login_required
def configurations_page():
    agencies = Agency.query.order_by(Agency.name.asc()).all()
    functions = Function.query.order_by(Function.name.asc()).all()
    return render_template('configurations.html', agencies=agencies, functions=functions, selected_agency_id=None)

@config_bp.route('/agencies/<int:agency_id>/configurations')
@login_required
def agency_configurations_page(agency_id):
    agency = Agency.query.get_or_404(agency_id)
    agencies = Agency.query.order_by(Agency.name.asc()).all()
    functions = Function.query.order_by(Function.name.asc()).all()
    return render_template('configurations.html', agency=agency, agencies=agencies, functions=functions, selected_agency_id=agency.id)

# --------- Configuration API ---------

@config_bp.route('/api/configurations/list')
@login_required
def configurations_list():
    agency_id = request.args.get('agency_id', type=int)
    function_id = request.args.get('function_id', type=int)
    status = (request.args.get('status') or '').strip()
    q = Configuration.query.options(
        joinedload(Configuration.agency),
        joinedload(Configuration.function).joinedload(Function.functional_area),
        joinedload(Configuration.component),
        joinedload(Configuration.products).joinedload(ConfigurationProduct.product).joinedload(Product.vendor),
        joinedload(Configuration.products).joinedload(ConfigurationProduct.product_version)
    )
    if agency_id:
        q = q.filter(Configuration.agency_id == agency_id)
    if function_id:
        q = q.filter(Configuration.function_id == function_id)
    if status:
        q = q.filter(Configuration.status == status)
    configs = q.order_by(Configuration.created_at.desc()).limit(250).all()
    return render_template('fragments/configuration_list.html', configurations=configs)

@config_bp.route('/api/configurations/<int:config_id>/row')
@login_required
def configuration_row(config_id):
    c = Configuration.query.get_or_404(config_id)
    return render_template('fragments/configuration_row.html', c=c)

@config_bp.route('/api/configurations/<int:config_id>/details')
@login_required
def configuration_details(config_id):
    c = Configuration.query.get_or_404(config_id)
    warnings = advisory_validate(c, [cp.product for cp in c.products])
    return render_template('fragments/configuration_details.html', c=c, warnings=warnings)

@config_bp.route('/api/configurations', methods=['POST'])
@login_required
def configuration_create():
    form = ConfigurationForm()
    if form.validate_on_submit():
        c = Configuration()
        form.populate_configuration(c)
        db.session.add(c)
        db.session.flush()
        hist = ConfigurationHistory(configuration_id=c.id, action='created', changed_by=get_updated_by(), new_values={})
        db.session.add(hist)
        db.session.commit()
        return render_template('fragments/configuration_row.html', c=c), 201
    return jsonify({'error': 'validation', 'messages': form.errors}), 400

@config_bp.route('/api/configurations/<int:config_id>', methods=['POST'])
@login_required
def configuration_update(config_id):
    c = Configuration.query.get_or_404(config_id)
    form = ConfigurationForm()
    if form.validate_on_submit():
        old = { 'status': c.status, 'version_label': c.version_label }
        form.populate_configuration(c)
        hist = ConfigurationHistory(configuration_id=c.id, action='updated', changed_by=get_updated_by(), old_values=old, new_values={'status': c.status, 'version_label': c.version_label})
        db.session.add(hist)
        db.session.commit()
        return render_template('fragments/configuration_row.html', c=c)
    return jsonify({'error': 'validation', 'messages': form.errors}), 400

@config_bp.route('/api/configurations/<int:config_id>', methods=['DELETE'])
@login_required
def configuration_delete(config_id):
    c = Configuration.query.get_or_404(config_id)
    hist = ConfigurationHistory(configuration_id=c.id, action='deleted', changed_by=get_updated_by(), old_values={'id': c.id})
    db.session.add(hist)
    db.session.delete(c)
    db.session.commit()
    return jsonify({'status': 'deleted', 'id': config_id})

@config_bp.route('/api/configurations/<int:config_id>/history')
@login_required
def configuration_history(config_id):
    c = Configuration.query.get_or_404(config_id)
    history = ConfigurationHistory.query.filter_by(configuration_id=config_id).order_by(ConfigurationHistory.timestamp.desc()).all()
    return render_template('fragments/configuration_history.html', c=c, history=history)

# --------- ConfigurationProduct API ---------

@config_bp.route('/api/configurations/<int:config_id>/products/list')
@login_required
def configuration_products_list(config_id):
    c = Configuration.query.get_or_404(config_id)
    return render_template('fragments/configuration_products_list.html', c=c, products=c.products)

@config_bp.route('/api/configurations/<int:config_id>/products/form')
@login_required
def configuration_product_form(config_id):
    c = Configuration.query.get_or_404(config_id)
    form = ConfigurationProductForm()
    form.configuration_id.data = str(c.id)
    return render_template('fragments/configuration_product_form.html', form=form, configuration=c)

@config_bp.route('/api/configurations/<int:config_id>/products', methods=['POST'])
@login_required
def configuration_product_create(config_id):
    c = Configuration.query.get_or_404(config_id)
    form = ConfigurationProductForm()
    if form.validate_on_submit():
        cp = ConfigurationProduct()
        form.populate_configuration_product(cp)
        cp.configuration_id = c.id
        db.session.add(cp)
        db.session.flush()
        hist = ConfigurationHistory(configuration_id=c.id, action='product_added', changed_by=get_updated_by(), new_values={'configuration_product_id': cp.id})
        db.session.add(hist)
        db.session.commit()
        return render_template('fragments/configuration_products_list.html', c=c, products=c.products)
    return jsonify({'error': 'validation', 'messages': form.errors}), 400

@config_bp.route('/api/configuration-products/<int:cp_id>', methods=['POST'])
@login_required
def configuration_product_update(cp_id):
    cp = ConfigurationProduct.query.get_or_404(cp_id)
    form = ConfigurationProductForm()
    if form.validate_on_submit():
        old = {'status': cp.status}
        form.populate_configuration_product(cp)
        hist = ConfigurationHistory(configuration_id=cp.configuration_id, action='product_updated', changed_by=get_updated_by(), old_values=old, new_values={'status': cp.status})
        db.session.add(hist)
        db.session.commit()
        configuration = Configuration.query.get(cp.configuration_id)
        return render_template('fragments/configuration_products_list.html', c=configuration, products=configuration.products)
    return jsonify({'error': 'validation', 'messages': form.errors}), 400

@config_bp.route('/api/configuration-products/<int:cp_id>', methods=['DELETE'])
@login_required
def configuration_product_delete(cp_id):
    cp = ConfigurationProduct.query.get_or_404(cp_id)
    configuration_id = cp.configuration_id
    hist = ConfigurationHistory(configuration_id=configuration_id, action='product_removed', changed_by=get_updated_by(), old_values={'configuration_product_id': cp.id})
    db.session.add(hist)
    db.session.delete(cp)
    db.session.commit()
    configuration = Configuration.query.get(configuration_id)
    return render_template('fragments/configuration_products_list.html', c=configuration, products=configuration.products)

# --------- Product & Versions API ---------

@config_bp.route('/products')
@login_required
def products_page():
    vendors = Vendor.query.order_by(Vendor.name.asc()).all()
    return render_template('products.html', vendors=vendors)

@config_bp.route('/api/products/list')
@login_required
def products_list():
    vendor_id = request.args.get('vendor_id', type=int)
    search = (request.args.get('q') or request.args.get('search') or '').strip()
    q = Product.query
    if vendor_id:
        q = q.filter(Product.vendor_id == vendor_id)
    if search:
        q = q.filter(Product.name.ilike(f"%{search}%"))
    products = q.order_by(Product.name.asc()).limit(250).all()
    return render_template('fragments/product_list.html', products=products)

# New: lightweight product picker endpoint for HTMX search suggestions
@config_bp.route('/api/products/picker')
@login_required
def products_picker():
    search = (request.args.get('q') or '').strip()
    vendor_id = request.args.get('vendor_id', type=int)
    configuration_id = request.args.get('configuration_id', type=int)
    q = Product.query
    if vendor_id:
        q = q.filter(Product.vendor_id == vendor_id)
    if search:
        q = q.filter(Product.name.ilike(f"%{search}%"))
    products = q.order_by(Product.name.asc()).limit(50).all()
    return render_template('fragments/product_picker_options.html', products=products, configuration_id=configuration_id)

@config_bp.route('/api/products/<int:product_id>/details')
@login_required
def product_details(product_id):
    p = Product.query.get_or_404(product_id)
    versions = ProductVersion.query.filter_by(product_id=product_id).order_by(ProductVersion.release_date.desc().nullslast()).all()
    return render_template('fragments/product_details.html', p=p, versions=versions)

@config_bp.route('/api/products/form')
@login_required
def product_form():
    form = ProductForm()
    vendors = Vendor.query.order_by(Vendor.name.asc()).all()
    try:
        # If vendor_id is a SelectField, set choices for validation/rendering
        form.vendor_id.choices = [(v.id, v.name) for v in vendors]
    except Exception:
        pass
    return render_template('fragments/product_form.html', form=form, vendors=vendors)

@config_bp.route('/api/products', methods=['POST'])
@login_required
def product_create():
    form = ProductForm()
    vendors = Vendor.query.order_by(Vendor.name.asc()).all()
    try:
        form.vendor_id.choices = [(v.id, v.name) for v in vendors]
    except Exception:
        pass
    if form.validate_on_submit():
        p = Product()
        form.populate_product(p)
        db.session.add(p)
        db.session.commit()
        return render_template('fragments/product_list.html', products=Product.query.order_by(Product.name.asc()).all()), 201
    return jsonify({'error': 'validation', 'messages': form.errors}), 400

@config_bp.route('/api/products/<int:product_id>/versions/list')
@login_required
def product_versions_list(product_id):
    p = Product.query.get_or_404(product_id)
    versions = ProductVersion.query.filter_by(product_id=product_id).order_by(ProductVersion.release_date.desc().nullslast()).all()
    return render_template('fragments/product_versions_list.html', p=p, versions=versions)

@config_bp.route('/api/products/<int:product_id>/versions/form')
@login_required
def product_version_form(product_id):
    p = Product.query.get_or_404(product_id)
    form = ProductVersionForm()
    form.product_id.data = str(p.id)
    return render_template('fragments/product_version_form.html', form=form, product=p)

@config_bp.route('/api/products/<int:product_id>/versions', methods=['POST'])
@login_required
def product_version_create(product_id):
    p = Product.query.get_or_404(product_id)
    form = ProductVersionForm()
    if form.validate_on_submit():
        pv = ProductVersion()
        form.populate_version(pv)
        pv.product_id = p.id
        db.session.add(pv)
        db.session.commit()
        versions = ProductVersion.query.filter_by(product_id=product_id).order_by(ProductVersion.release_date.desc().nullslast()).all()
        return render_template('fragments/product_versions_list.html', p=p, versions=versions), 201
    return jsonify({'error': 'validation', 'messages': form.errors}), 400

# --------- Wizard (Config) ---------

@config_bp.route('/api/wizard/config/step1')
@login_required
def wizard_config_step1():
    selected_agency_id = request.args.get('agency_id', type=int)
    agencies = Agency.query.order_by(Agency.name.asc()).all()
    functions = Function.query.order_by(Function.name.asc()).all()
    functional_areas = FunctionalArea.query.order_by(FunctionalArea.name.asc()).all()
    return render_template('fragments/wizard_config_step1.html', agencies=agencies, functions=functions, functional_areas=functional_areas, selected_agency_id=selected_agency_id)

@config_bp.route('/api/wizard/config/step2')
@login_required
def wizard_config_step2():
    agency_id = request.args.get('agency_id', type=int)
    function_id = request.args.get('function_id', type=int)
    components = []
    if function_id:
        func = Function.query.get(function_id)
        if func:
            components = sorted(func.components, key=lambda c: c.name.lower())
    if not components:
        components = Component.query.order_by(Component.name.asc()).all()
    return render_template('fragments/wizard_config_step2.html', components=components, agency_id=agency_id, function_id=function_id)

@config_bp.route('/api/wizard/config/step3')
@login_required
def wizard_config_step3():
    agency_id = request.args.get('agency_id', type=int)
    function_id = request.args.get('function_id', type=int)
    component_id = request.args.get('component_id', type=int)
    products = Product.query.order_by(Product.name.asc()).all()
    return render_template('fragments/wizard_config_step3.html', products=products, agency_id=agency_id, function_id=function_id, component_id=component_id)

@config_bp.route('/api/wizard/config/step4')
@login_required
def wizard_config_step4():
    agency_id = request.args.get('agency_id', type=int)
    function_id = request.args.get('function_id', type=int)
    component_id = request.args.get('component_id', type=int)
    # selected products list (supports repeated params or comma-separated ids)
    ids = _parse_product_ids(request.args)
    selected_products = Product.query.filter(Product.id.in_(ids)).all() if ids else []
    fake_config = Configuration(agency_id=agency_id, function_id=function_id, component_id=component_id, status='Draft')
    warnings = advisory_validate(fake_config, selected_products)
    return render_template('fragments/wizard_config_step4.html', agency_id=agency_id, function_id=function_id, component_id=component_id, products=selected_products, product_ids=ids, warnings=warnings)

@config_bp.route('/api/wizard/config/confirm', methods=['POST'])
@login_required
def wizard_config_confirm():
    try:
        # Create configuration
        form = ConfigurationForm()
        if not form.validate_on_submit():
            return jsonify({'error': 'validation', 'messages': form.errors}), 400
        c = Configuration()
        form.populate_configuration(c)
        db.session.add(c)
        db.session.flush()
        db.session.add(ConfigurationHistory(configuration_id=c.id, action='created', changed_by=get_updated_by(), new_values={}))
        # Attach products if provided
        ids = _parse_product_ids(request.form)
        for pid in ids:
            cp = ConfigurationProduct(configuration_id=c.id, product_id=pid, status='Active')
            db.session.add(cp)
            db.session.flush()
            db.session.add(ConfigurationHistory(configuration_id=c.id, action='product_added', changed_by=get_updated_by(), new_values={'configuration_product_id': cp.id}))
        db.session.commit()
        return render_template('fragments/configuration_row.html', c=c), 201
    except Exception as e:
        db.session.rollback()
        return jsonify({'error': 'server', 'message': str(e)}), 500

@config_bp.route('/api/products/<int:product_id>/form')
@login_required
def product_edit_form(product_id):
    p = Product.query.get_or_404(product_id)
    form = ProductForm()
    vendors = Vendor.query.order_by(Vendor.name.asc()).all()
    try:
        form.vendor_id.choices = [(v.id, v.name) for v in vendors]
    except Exception:
        pass
    form.populate_from_product(p)
    return render_template('fragments/product_form.html', form=form, product=p, vendors=vendors)

@config_bp.route('/api/products/<int:product_id>', methods=['PUT'])
@login_required
def product_update(product_id):
    p = Product.query.get_or_404(product_id)
    form = ProductForm()
    vendors = Vendor.query.order_by(Vendor.name.asc()).all()
    try:
        form.vendor_id.choices = [(v.id, v.name) for v in vendors]
    except Exception:
        pass
    if form.validate_on_submit():
        form.populate_product(p)
        db.session.commit()
        products = Product.query.order_by(Product.name.asc()).limit(250).all()
        return render_template('fragments/product_list.html', products=products)
    return jsonify({'error': 'validation', 'messages': form.errors}), 400

@config_bp.route('/api/products/<int:product_id>', methods=['DELETE'])
@login_required
def product_delete(product_id):
    p = Product.query.get_or_404(product_id)
    # Guard: block deletion if used in any configuration
    usage = ConfigurationProduct.query.filter_by(product_id=product_id).first()
    if usage:
        return jsonify({'error': 'in_use', 'message': 'Cannot delete product; it is used in one or more configurations.'}), 400
    db.session.delete(p)
    db.session.commit()
    products = Product.query.order_by(Product.name.asc()).limit(250).all()
    return render_template('fragments/product_list.html', products=products)

@config_bp.route('/api/configurations/<int:config_id>/form')
@login_required
def configuration_edit_form(config_id):
    c = Configuration.query.get_or_404(config_id)
    form = ConfigurationForm()
    form.populate_from_configuration(c)
    agencies = Agency.query.order_by(Agency.name.asc()).all()
    functions = Function.query.order_by(Function.name.asc()).all()
    components = Component.query.order_by(Component.name.asc()).all()
    return render_template('fragments/configuration_edit_form.html', form=form, c=c, agencies=agencies, functions=functions, components=components)

# --------- Options (for HTMX dependent selects) ---------

@config_bp.route('/api/options/functional-areas')
@login_required
def option_functional_areas():
    areas = FunctionalArea.query.order_by(FunctionalArea.name.asc()).all()
    html = '<option value="">All Functional Areas</option>'
    for a in areas:
        html += f'<option value="{a.id}">{a.name}</option>'
    return html

@config_bp.route('/api/options/functions')
@login_required
def option_functions():
    # Support multiple param names from different UIs
    fa_id = request.args.get('qc-fa') or request.args.get('functional_area_id') or request.args.get('functional_area') or request.args.get('fa_id')
    try:
        fa_id = int(fa_id) if fa_id else None
    except (TypeError, ValueError):
        fa_id = None
    q = (request.args.get('q') or '').strip()

    qry = Function.query
    if fa_id:
        qry = qry.filter(Function.functional_area_id == fa_id)
    if q:
        qry = qry.filter(Function.name.ilike(f"%{q}%"))
    functions = qry.order_by(Function.name.asc()).limit(200).all()

    html = '<option value="">Select a function</option>'
    for f in functions:
        html += f'<option value="{f.id}">{f.name}</option>'
    return html

@config_bp.route('/api/options/components')
@login_required
def option_components():
    function_id = request.args.get('function_id', type=int)
    components = []
    if function_id:
        fn = Function.query.get(function_id)
        if fn:
            # fn.components is a list; sort case-insensitively
            components = sorted(fn.components, key=lambda c: (c.name or '').lower())
    if not components:
        components = Component.query.order_by(Component.name.asc()).limit(200).all()

    html = '<option value="">Select a component</option>'
    for c in components:
        html += f'<option value="{c.id}">{c.name}</option>'
    return html


# --------- CSV Import ---------

@config_bp.route('/configurations/import')
@login_required
def configurations_import_page():
    """Show CSV import form."""
    agencies = Agency.query.order_by(Agency.name.asc()).all()
    return render_template('configurations_import.html', agencies=agencies)


@config_bp.route('/api/configurations/import', methods=['POST'])
@login_required
def configurations_import():
    """Process CSV import of product configurations."""
    agency_id = request.form.get('agency_id', type=int)
    file = request.files.get('csv_file')

    if not file or not file.filename.endswith('.csv'):
        return jsonify({'error': 'Please upload a valid CSV file'}), 400

    try:
        content = file.stream.read().decode('utf-8')
        reader = csv.DictReader(StringIO(content))

        results = {'created': 0, 'updated': 0, 'skipped': 0, 'errors': []}

        for row_num, row in enumerate(reader, start=2):
            try:
                result = _process_import_row(row, agency_id)
                if result == 'created':
                    results['created'] += 1
                elif result == 'updated':
                    results['updated'] += 1
                elif result == 'skipped':
                    results['skipped'] += 1
            except Exception as e:
                results['errors'].append(f"Row {row_num}: {str(e)}")

        db.session.commit()
        return jsonify(results)
    except Exception as e:
        db.session.rollback()
        return jsonify({'error': f'Import failed: {str(e)}'}), 500


def _process_import_row(row: dict, default_agency_id: int = None) -> str:
    """Process a single CSV row. Returns 'created', 'updated', or 'skipped'."""

    # --- Resolve Agency ---
    agency_name = (row.get('agency_name') or '').strip()
    if agency_name:
        agency = Agency.query.filter(Agency.name.ilike(agency_name)).first()
        if not agency:
            raise ValueError(f"Agency '{agency_name}' not found")
    elif default_agency_id:
        agency = Agency.query.get(default_agency_id)
        if not agency:
            raise ValueError(f"Default agency ID {default_agency_id} not found")
    else:
        raise ValueError("No agency specified")

    # --- Resolve FunctionalArea and Function ---
    fa_name = (row.get('functional_area') or '').strip()
    func_name = (row.get('function') or '').strip()
    if not fa_name or not func_name:
        raise ValueError("functional_area and function are required")

    fa = FunctionalArea.query.filter(FunctionalArea.name.ilike(fa_name)).first()
    if not fa:
        raise ValueError(f"Functional area '{fa_name}' not found")

    function = Function.query.filter(
        Function.name.ilike(func_name),
        Function.functional_area_id == fa.id
    ).first()
    if not function:
        raise ValueError(f"Function '{func_name}' not found in '{fa_name}'")

    # --- Resolve or create Component ---
    comp_name = (row.get('component') or '').strip()
    if not comp_name:
        raise ValueError("component is required")

    component = Component.query.filter(Component.name.ilike(comp_name)).first()
    if not component:
        component = Component(name=comp_name)
        db.session.add(component)
        db.session.flush()

    # --- Find or create Configuration ---
    config = Configuration.query.filter_by(
        agency_id=agency.id,
        function_id=function.id,
        component_id=component.id
    ).first()

    action = 'updated' if config else 'created'

    if not config:
        config = Configuration(
            agency_id=agency.id,
            function_id=function.id,
            component_id=component.id
        )
        db.session.add(config)
        db.session.flush()
        db.session.add(ConfigurationHistory(
            configuration_id=config.id,
            action='created',
            changed_by=get_updated_by(),
            new_values={'source': 'csv_import'}
        ))

    # --- Update configuration fields ---
    status_val = (row.get('status') or '').strip()
    if status_val:
        config.status = status_val

    deployment_str = (row.get('deployment_date') or '').strip()
    if deployment_str:
        try:
            config.deployment_date = datetime.strptime(deployment_str, '%Y-%m-%d').date()
        except ValueError:
            pass  # ignore invalid dates

    notes_val = (row.get('notes') or '').strip()
    if notes_val:
        config.implementation_notes = notes_val

    version_label_val = (row.get('version_label') or '').strip()
    if version_label_val:
        config.version_label = version_label_val

    # --- Handle Product attachment ---
    product_name = (row.get('product') or '').strip()
    vendor_name = (row.get('vendor') or '').strip()

    if product_name:
        # Resolve or create Vendor
        vendor = None
        if vendor_name:
            vendor = Vendor.query.filter(Vendor.name.ilike(vendor_name)).first()
            if not vendor:
                vendor = Vendor(name=vendor_name)
                db.session.add(vendor)
                db.session.flush()

        # Resolve or create Product (match by name + vendor if vendor specified)
        product_q = Product.query.filter(Product.name.ilike(product_name))
        if vendor:
            # Exact match: same name AND same vendor
            product_q = product_q.filter(Product.vendor_id == vendor.id)
        else:
            # No vendor specified: prefer products without a vendor, else take any match
            product_q = product_q.order_by(Product.vendor_id.asc().nullsfirst())
        product = product_q.first()

        if not product:
            product = Product(name=product_name, vendor_id=vendor.id if vendor else None)
            db.session.add(product)
            db.session.flush()

        # Resolve ProductVersion if specified
        version_str = (row.get('product_version') or '').strip()
        product_version = None
        if version_str:
            product_version = ProductVersion.query.filter_by(
                product_id=product.id,
                version=version_str
            ).first()
            if not product_version:
                product_version = ProductVersion(product_id=product.id, version=version_str)
                db.session.add(product_version)
                db.session.flush()

        # Link product to configuration (upsert)
        cp = ConfigurationProduct.query.filter_by(
            configuration_id=config.id,
            product_id=product.id
        ).first()

        if not cp:
            cp = ConfigurationProduct(
                configuration_id=config.id,
                product_id=product.id,
                status='Active'
            )
            db.session.add(cp)
            db.session.add(ConfigurationHistory(
                configuration_id=config.id,
                action='product_added',
                changed_by=get_updated_by(),
                new_values={'product_id': product.id, 'source': 'csv_import'}
            ))

        cp.product_version_id = product_version.id if product_version else None

    return action


@config_bp.route('/api/configurations/export-template')
@login_required
def configurations_export_template():
    """Download a sample CSV template for import."""
    import io
    output = io.StringIO()
    writer = csv.writer(output)
    writer.writerow([
        'agency_name', 'functional_area', 'function', 'component',
        'product', 'vendor', 'product_version', 'status', 'deployment_date', 'version_label', 'notes'
    ])
    # Example row
    writer.writerow([
        'Metro Transit', 'Operations', 'Real-time Tracking', 'AVL System',
        'TransitMaster', 'Trapeze', '5.2.1', 'Active', '2023-06-15', 'v5.2.1-prod', 'Primary AVL system'
    ])
    output.seek(0)
    return Response(
        output.getvalue(),
        mimetype='text/csv',
        headers={'Content-Disposition': 'attachment; filename=configurations_import_template.csv'}
    )


# End of app/routes/configurations.py

# Start of app/models/tran.py
# models/tran.py

from datetime import datetime
from app import db
import enum
import os

# Association Tables
component_integration = db.Table(
    'component_integration',
    db.Column('component_id', db.Integer, db.ForeignKey('components.id'), primary_key=True),
    db.Column('integration_point_id', db.Integer, db.ForeignKey('integration_points.id'), primary_key=True)
)

function_component = db.Table(
    'function_component',
    db.Column('function_id', db.Integer, db.ForeignKey('functions.id'), primary_key=True),
    db.Column('component_id', db.Integer, db.ForeignKey('components.id'), primary_key=True)
)

component_tag = db.Table(
    'component_tag',
    db.Column('component_id', db.Integer, db.ForeignKey('components.id'), primary_key=True),
    db.Column('tag_id', db.Integer, db.ForeignKey('tags.id'), primary_key=True)
)

integration_tag = db.Table(
    'integration_tag',
    db.Column('integration_point_id', db.Integer, db.ForeignKey('integration_points.id'), primary_key=True),
    db.Column('tag_id', db.Integer, db.ForeignKey('tags.id'), primary_key=True)
)

integration_standard = db.Table(
    'integration_standard',
    db.Column('integration_point_id', db.Integer, db.ForeignKey('integration_points.id'), primary_key=True),
    db.Column('standard_id', db.Integer, db.ForeignKey('standards.id'), primary_key=True)
)

product_integration = db.Table(
    'product_integration',
    db.Column('product_id', db.Integer, db.ForeignKey('products.id'), primary_key=True),
    db.Column('integration_point_id', db.Integer, db.ForeignKey('integration_points.id'), primary_key=True)
)

# Enums
class Criticality(enum.Enum):
    high = "high"
    medium = "medium"
    low = "low"

class LifecycleStage(enum.Enum):
    planned = "planned"          # Identified / slated for adoption
    pilot = "pilot"              # Limited trial
    production = "production"    # Broad/standard use
    deprecated = "deprecated"    # Use discouraged; in transition
    retired = "retired"          # No longer in use/supported

# Core Models
class Agency(db.Model):
    __tablename__ = 'agencies'

    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), unique=True, nullable=False)
    location = db.Column(db.String(100))
    description = db.Column(db.String(500))
    website = db.Column(db.String(255))
    email_domain = db.Column(db.String(255))
    ceo = db.Column(db.String(128))
    address_hq = db.Column(db.String(256))
    phone_number = db.Column(db.String(64))
    transit_map_link = db.Column(db.String(256))
    contact_email = db.Column(db.String(255))
    contact_phone = db.Column(db.String(50))
    contact_name = db.Column(db.String(100))
    short_name = db.Column(db.String(50)) # use short name for constructing agency specific URLs for images, etc.
    additional_metadata = db.Column(db.JSON)
    __table_args__ = (
        db.UniqueConstraint('name', name='uq_transit_system_name'),
    )

    configurations = db.relationship('Configuration', back_populates='agency', cascade='all, delete-orphan')
    
    def __repr__(self):
        return f"<Agency(name={self.name}, location={self.location})>"
    
    @property
    def logo_url(self):
        """Generate agency logo URL if file exists"""
        from flask import url_for, current_app
        if self.short_name:
            filename = f"{self.short_name.lower().replace(' ', '_')}_logo.png"
            full_path = os.path.join(current_app.static_folder, 'images', 'agency_logos', filename)
            if os.path.exists(full_path):
                return url_for('static', filename=f'images/agency_logos/{filename}')
        return None
    
    @property
    def header_url(self):
        """Generate agency header URL if file exists"""
        from flask import url_for, current_app
        if self.short_name:
            filename = f"{self.short_name.lower().replace(' ', '_')}_header.png"
            full_path = os.path.join(current_app.static_folder, 'images', 'agency_headers', filename)
            if os.path.exists(full_path):
                return url_for('static', filename=f'images/agency_headers/{filename}')
        return None

class FunctionalArea(db.Model):
    __tablename__ = 'functional_areas'

    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    description = db.Column(db.String(500))

    functions = db.relationship('Function', back_populates='functional_area', cascade='all, delete-orphan')

    def __repr__(self):
        return f"<FunctionalArea(name={self.name})>"

class Function(db.Model):
    __tablename__ = 'functions'

    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    description = db.Column(db.String(500))
    criticality = db.Column(db.Enum(Criticality), default=Criticality.medium, nullable=False)

    functional_area_id = db.Column(db.Integer, db.ForeignKey('functional_areas.id'), nullable=False)
    functional_area = db.relationship('FunctionalArea', back_populates='functions')

    components = db.relationship('Component', secondary='function_component', back_populates='functions')
    configurations = db.relationship('Configuration', back_populates='function', cascade='all, delete-orphan')

    def __repr__(self):
        return f"<Function(name={self.name}, criticality={self.criticality.value})>"

class Vendor(db.Model):
    __tablename__ = 'vendors'
    __table_args__ = (
        db.UniqueConstraint('name', name='uq_vendor_name'),
    )

    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    short_name = db.Column(db.String(50))
    website = db.Column(db.String(255))
    vendor_email = db.Column(db.String(255)) #TODO: Create field to store vendor email domain 
    vendor_phone = db.Column(db.String(50))
    description = db.Column(db.String(500))

    products = db.relationship('Product', back_populates='vendor', cascade='all, delete-orphan')

    def __repr__(self):
        return f"<Vendor(name={self.name})>"
    
    @property
    def logo_url(self):
        """Generate vendor logo URL if file exists"""
        from flask import url_for, current_app
        if self.short_name:
            filename = f"{self.short_name.lower().replace(' ', '_')}_logo.png"
            full_path = os.path.join(current_app.static_folder, 'images', 'vendor_logos', filename)
            if os.path.exists(full_path):
                return url_for('static', filename=f'images/vendor_logos/{filename}')
        return None
    
    @property
    def header_url(self):
        """Generate vendor header URL if file exists"""
        from flask import url_for, current_app
        if self.short_name:
            filename = f"{self.short_name.lower().replace(' ', '_')}_header.png"
            full_path = os.path.join(current_app.static_folder, 'images', 'vendor_headers', filename)
            if os.path.exists(full_path):
                return url_for('static', filename=f'images/vendor_headers/{filename}')
        return None

class Component(db.Model):
    __tablename__ = 'components'

    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    description = db.Column(db.String(1000))
    short_description = db.Column(db.String(200))
    additional_metadata = db.Column(db.JSON)

    functions = db.relationship('Function', secondary='function_component', back_populates='components')
    integration_points = db.relationship('IntegrationPoint', secondary='component_integration', back_populates='components')
    tags = db.relationship('Tag', secondary='component_tag', back_populates='components')
    user_roles = db.relationship('UserRole', back_populates='component', cascade='all, delete-orphan')
    update_logs = db.relationship('UpdateLog', back_populates='component', cascade='all, delete-orphan')
    configurations = db.relationship('Configuration', back_populates='component', cascade='all, delete-orphan')

    def __repr__(self):
        return f"<Component(name={self.name})>" # UPDATED __repr__

class IntegrationPoint(db.Model):
    __tablename__ = 'integration_points'

    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    description = db.Column(db.String(500))
    website = db.Column(db.String(255))

    standards = db.relationship('Standard', secondary=integration_standard, back_populates='integration_points')
    components = db.relationship('Component', secondary='component_integration', back_populates='integration_points')
    tags = db.relationship('Tag', secondary=integration_tag, back_populates='integration_points')
    products = db.relationship('Product', secondary='product_integration', back_populates='integration_points')

    def __repr__(self):
        return f"<IntegrationPoint(name={self.name})>"

class Standard(db.Model):
    __tablename__ = 'standards'

    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), unique=True, nullable=False)
    description = db.Column(db.String(500))
    version = db.Column(db.String(50))
    standard_url = db.Column(db.String(255))

    integration_points = db.relationship('IntegrationPoint', secondary=integration_standard, back_populates='standards')

    def __repr__(self):
        return f"<Standard(name={self.name}, version={self.version})>"

class TagGroup(db.Model):
    __tablename__ = 'tag_groups'

    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), unique=True, nullable=False)
    description = db.Column(db.String(500))

    tags = db.relationship('Tag', back_populates='tag_group', cascade='all, delete-orphan')

    def __repr__(self):
        return f"<TagGroup(name={self.name})>"

class Tag(db.Model):
    __tablename__ = 'tags'

    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    description = db.Column(db.String(500))
    color = db.Column(db.String(20))

    tag_group_id = db.Column(db.Integer, db.ForeignKey('tag_groups.id'), nullable=False)
    tag_group = db.relationship('TagGroup', back_populates='tags')

    components = db.relationship('Component', secondary='component_tag', back_populates='tags')
    integration_points = db.relationship('IntegrationPoint', secondary=integration_tag, back_populates='tags')

    def __repr__(self):
        return f"<Tag(name={self.name})>"
    
class UserRole(db.Model):
    __tablename__ = 'user_roles'

    id = db.Column(db.Integer, primary_key=True)
    role_name = db.Column(db.String(100), nullable=False)
    description = db.Column(db.String(500))

    component_id = db.Column(db.Integer, db.ForeignKey('components.id'))
    component = db.relationship('Component', back_populates='user_roles')

    def __repr__(self):
        return f"<UserRole(role_name={self.role_name})>"

class UpdateLog(db.Model):
    __tablename__ = 'update_logs'

    id = db.Column(db.Integer, primary_key=True)
    component_id = db.Column(db.Integer, db.ForeignKey('components.id'), nullable=False)
    updated_by = db.Column(db.String(100), nullable=False)
    update_date = db.Column(db.DateTime, default=datetime.utcnow)
    change_summary = db.Column(db.String(1000))

    component = db.relationship('Component', back_populates='update_logs')

    def __repr__(self):
        return f"<UpdateLog(component_id={self.component_id}, updated_by={self.updated_by})>"

class Product(db.Model):
    __tablename__ = 'products'
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(150), nullable=False, unique=True)
    vendor_id = db.Column(db.Integer, db.ForeignKey('vendors.id'), nullable=True, index=True)
    description = db.Column(db.String(1000))
    parent_product_id = db.Column(db.Integer, db.ForeignKey('products.id'), nullable=True, index=True)
    lifecycle_stage = db.Column(db.Enum(LifecycleStage), nullable=True)
    additional_metadata = db.Column(db.JSON)

    vendor = db.relationship('Vendor', back_populates='products')
    parent_product = db.relationship('Product', remote_side=[id], backref=db.backref('child_products', cascade='all, delete-orphan'))
    versions = db.relationship('ProductVersion', back_populates='product', cascade='all, delete-orphan')
    integration_points = db.relationship('IntegrationPoint', secondary='product_integration', back_populates='products')
    configuration_products = db.relationship('ConfigurationProduct', back_populates='product', cascade='all, delete-orphan')

    def __repr__(self):
        return f"<Product(name={self.name})>"

class ProductVersion(db.Model):
    __tablename__ = 'product_versions'
    id = db.Column(db.Integer, primary_key=True)
    product_id = db.Column(db.Integer, db.ForeignKey('products.id'), nullable=False, index=True)
    version = db.Column(db.String(100), nullable=False)
    release_date = db.Column(db.Date, nullable=True)
    support_end_date = db.Column(db.Date, nullable=True)
    notes = db.Column(db.String(1000))

    product = db.relationship('Product', back_populates='versions')
    configuration_products = db.relationship('ConfigurationProduct', back_populates='product_version')

    __table_args__ = (
        db.UniqueConstraint('product_id', 'version', name='uq_product_version'),
        db.Index('ix_product_version_product_id_version', 'product_id', 'version'),
    )

    def __repr__(self):
        return f"<ProductVersion(product_id={self.product_id}, version={self.version})>"

class Configuration(db.Model):
    __tablename__ = 'configurations'
    id = db.Column(db.Integer, primary_key=True)
    agency_id = db.Column(db.Integer, db.ForeignKey('agencies.id'), nullable=False, index=True)
    function_id = db.Column(db.Integer, db.ForeignKey('functions.id'), nullable=False, index=True)
    component_id = db.Column(db.Integer, db.ForeignKey('components.id'), nullable=False, index=True)
    status = db.Column(db.String(50), default='Active', nullable=False, index=True)
    deployment_date = db.Column(db.Date, nullable=True)
    version_label = db.Column(db.String(100))
    implementation_notes = db.Column(db.String(1000))
    security_review_date = db.Column(db.Date, nullable=True)
    additional_metadata = db.Column(db.JSON)
    created_at = db.Column(db.DateTime, default=datetime.utcnow, nullable=False)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)

    agency = db.relationship('Agency', back_populates='configurations')
    function = db.relationship('Function', back_populates='configurations')
    component = db.relationship('Component', back_populates='configurations')
    products = db.relationship('ConfigurationProduct', back_populates='configuration', cascade='all, delete-orphan')
    history_entries = db.relationship('ConfigurationHistory', back_populates='configuration', cascade='all, delete-orphan')

    __table_args__ = (
        db.UniqueConstraint('agency_id', 'function_id', 'component_id', name='uq_configuration_agency_function_component'),
        db.Index('ix_configuration_agency_function', 'agency_id', 'function_id'),
        db.Index('ix_configuration_component', 'component_id'),
    )

    def __repr__(self):
        return f"<Configuration(agency_id={self.agency_id}, function_id={self.function_id}, component_id={self.component_id})>"

class ConfigurationProduct(db.Model):
    __tablename__ = 'configuration_products'
    id = db.Column(db.Integer, primary_key=True)
    configuration_id = db.Column(db.Integer, db.ForeignKey('configurations.id'), nullable=False, index=True)
    product_id = db.Column(db.Integer, db.ForeignKey('products.id'), nullable=False, index=True)
    product_version_id = db.Column(db.Integer, db.ForeignKey('product_versions.id'), nullable=True, index=True)
    status = db.Column(db.String(50), default='Active', nullable=False, index=True)
    deployment_date = db.Column(db.Date, nullable=True)
    settings = db.Column(db.JSON)  # free-form JSON for product-specific configuration
    created_at = db.Column(db.DateTime, default=datetime.utcnow, nullable=False)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)

    configuration = db.relationship('Configuration', back_populates='products')
    product = db.relationship('Product', back_populates='configuration_products')
    product_version = db.relationship('ProductVersion', back_populates='configuration_products')

    __table_args__ = (
        db.UniqueConstraint('configuration_id', 'product_id', name='uq_configuration_product'),
        db.Index('ix_configuration_product_product_version', 'product_id', 'product_version_id'),
    )

    def __repr__(self):
        return f"<ConfigurationProduct(configuration_id={self.configuration_id}, product_id={self.product_id}, version_id={self.product_version_id})>"

class ConfigurationHistory(db.Model):
    __tablename__ = 'configuration_history'
    id = db.Column(db.Integer, primary_key=True)
    configuration_id = db.Column(db.Integer, db.ForeignKey('configurations.id', ondelete='CASCADE'), nullable=False, index=True)
    timestamp = db.Column(db.DateTime, default=datetime.utcnow, index=True, nullable=False)
    action = db.Column(db.String(50), nullable=False)  # created, updated, status_change, product_added, product_removed, advisory_ack, deleted
    changed_by = db.Column(db.String(100))
    old_values = db.Column(db.JSON)
    new_values = db.Column(db.JSON)

    configuration = db.relationship('Configuration', back_populates='history_entries')

    def __repr__(self):
        return f"<ConfigurationHistory(configuration_id={self.configuration_id}, action={self.action}, timestamp={self.timestamp})>"

# End of app/models/tran.py

# Start of app/forms/forms.py
# app/forms.py (create this file)
from flask_wtf import FlaskForm
from wtforms import StringField, TextAreaField, EmailField, URLField, TelField, FieldList, FormField
from wtforms.validators import DataRequired, Email, URL, Optional, Length
from wtforms.widgets import TextArea

class MetadataField(FlaskForm):
    """Sub-form for metadata key-value pairs"""
    key = StringField('Key', validators=[Optional(), Length(max=100)])
    value = StringField('Value', validators=[Optional(), Length(max=500)])

class AgencyForm(FlaskForm):
    """Form for creating and editing transit agencies"""
    # Basic Information
    name = StringField('Agency Name', 
                      validators=[DataRequired(message="Agency name is required"), 
                                Length(max=100, message="Name must be less than 100 characters")])
    location = StringField('Location', 
                          validators=[Optional(), Length(max=100)])
    description = TextAreaField('Description', 
                               validators=[Optional(), Length(max=500)],
                               widget=TextArea())
    address_hq = TextAreaField('Headquarters Address', 
                              validators=[Optional(), Length(max=256)],
                              widget=TextArea())
    ceo = StringField('Chief Executive Officer', 
                     validators=[Optional(), Length(max=128)])
    contact_name = StringField('Primary Contact Name', 
                              validators=[Optional(), Length(max=100)])
    contact_email = EmailField('Primary Contact Email', 
                              validators=[Optional(), Email(message="Please enter a valid email address")])
    contact_phone = TelField('Primary Contact Phone', 
                            validators=[Optional(), Length(max=50)])
    phone_number = TelField('Main Phone Number', 
                           validators=[Optional(), Length(max=64)])
    website = URLField('Official Website', 
                      validators=[Optional(), URL(message="Please enter a valid URL")])
    transit_map_link = URLField('Transit Map URL', 
                              validators=[Optional(), URL(message="Please enter a valid URL")])
    email_domain = StringField('Agency Email Domain', validators=[Optional(), Length(max=255)])
    
    # Dynamic metadata fields will be handled separately in the template and route
    def populate_from_agency(self, agency):
        """Populate form with data from agency model"""
        self.name.data = agency.name
        self.location.data = agency.location
        self.description.data = agency.description
        self.address_hq.data = agency.address_hq
        self.ceo.data = agency.ceo
        self.contact_name.data = agency.contact_name
        self.contact_email.data = agency.contact_email
        self.contact_phone.data = agency.contact_phone
        self.phone_number.data = agency.phone_number
        self.website.data = agency.website
        self.transit_map_link.data = agency.transit_map_link
        self.email_domain.data = agency.email_domain
    
    def populate_agency(self, agency):
        """Populate agency model with form data"""
        agency.name = self.name.data
        agency.location = self.location.data or None
        agency.description = self.description.data or None
        agency.address_hq = self.address_hq.data or None
        agency.ceo = self.ceo.data or None
        agency.contact_name = self.contact_name.data or None
        agency.contact_email = self.contact_email.data or None
        agency.contact_phone = self.contact_phone.data or None
        agency.phone_number = self.phone_number.data or None
        agency.website = self.website.data or None
        agency.transit_map_link = self.transit_map_link.data or None
        agency.email_domain = (self.email_domain.data or None)

class VendorForm(FlaskForm):
    name = StringField('Vendor Name', validators=[DataRequired(), Length(min=2, max=100)])
    short_name = StringField('Short Name', validators=[Length(max=50)])
    description = TextAreaField('Description', validators=[Length(max=500)])
    website = URLField('Website', validators=[Optional(), URL()])
    vendor_email = StringField('General Email', validators=[Optional(), Email(), Length(max=255)])
    vendor_phone = StringField('General Phone', validators=[Optional(), Length(max=50)])
    
    def populate_from_vendor(self, vendor):
        """Populate form fields from vendor object"""
        self.name.data = vendor.name
        self.short_name.data = vendor.short_name
        self.description.data = vendor.description
        self.website.data = vendor.website
        self.vendor_email.data = vendor.vendor_email
        self.vendor_phone.data = vendor.vendor_phone
    
    def populate_vendor(self, vendor):
        """Populate vendor object from form data"""
        vendor.name = self.name.data
        vendor.short_name = self.short_name.data
        vendor.description = self.description.data
        vendor.website = self.website.data
        vendor.vendor_email = self.vendor_email.data
        vendor.vendor_phone = self.vendor_phone.data

class ComponentForm(FlaskForm):
    name = StringField('Component Name', validators=[DataRequired(), Length(min=2, max=100)])
    short_description = StringField('Short Description', validators=[Optional(), Length(max=200)])
    description = TextAreaField('Description', validators=[Optional(), Length(max=1000)])
    additional_metadata = TextAreaField('Additional Metadata (JSON)', validators=[Optional(), Length(max=5000)])

    def populate_from_component(self, component):
        self.name.data = component.name
        self.short_description.data = component.short_description
        self.description.data = component.description
        if component.additional_metadata:
            import json
            try:
                self.additional_metadata.data = json.dumps(component.additional_metadata, indent=2)
            except Exception:
                self.additional_metadata.data = ''

    def populate_component(self, component):
        component.name = self.name.data
        component.short_description = self.short_description.data or None
        component.description = self.description.data or None
        if self.additional_metadata.data:
            import json
            try:
                component.additional_metadata = json.loads(self.additional_metadata.data)
            except Exception:
                component.additional_metadata = None
        else:
            component.additional_metadata = None

# =============================
# Phase 3 ADDITIVE NEW FORMS
# =============================

class ProductForm(FlaskForm):
    name = StringField('Product Name', validators=[DataRequired(), Length(min=2, max=150)])
    vendor_id = StringField('Vendor', validators=[Optional(), Length(max=10)])
    description = TextAreaField('Description', validators=[Optional(), Length(max=1000)])
    parent_product_id = StringField('Parent Product', validators=[Optional(), Length(max=10)])
    lifecycle_stage = StringField('Lifecycle Stage', validators=[Optional(), Length(max=50)])
    additional_metadata = TextAreaField('Additional Metadata (JSON)', validators=[Optional(), Length(max=5000)])

    def populate_from_product(self, product):
        self.name.data = product.name
        self.vendor_id.data = str(product.vendor_id) if product.vendor_id else ''
        self.description.data = product.description
        self.parent_product_id.data = str(product.parent_product_id) if product.parent_product_id else ''
        self.lifecycle_stage.data = product.lifecycle_stage.value if getattr(product, 'lifecycle_stage', None) else ''
        if product.additional_metadata:
            import json
            try:
                self.additional_metadata.data = json.dumps(product.additional_metadata, indent=2)
            except Exception:
                self.additional_metadata.data = ''

    def populate_product(self, product):
        product.name = self.name.data
        product.vendor_id = int(self.vendor_id.data) if self.vendor_id.data else None
        product.description = self.description.data or None
        product.parent_product_id = int(self.parent_product_id.data) if self.parent_product_id.data else None
        from app.models.tran import LifecycleStage
        if self.lifecycle_stage.data:
            try:
                product.lifecycle_stage = LifecycleStage(self.lifecycle_stage.data)
            except Exception:
                product.lifecycle_stage = None
        if self.additional_metadata.data:
            import json
            try:
                product.additional_metadata = json.loads(self.additional_metadata.data)
            except Exception:
                product.additional_metadata = None
        else:
            product.additional_metadata = None

class ProductVersionForm(FlaskForm):
    product_id = StringField('Product', validators=[DataRequired(), Length(max=10)])
    version = StringField('Version', validators=[DataRequired(), Length(max=100)])
    release_date = StringField('Release Date', validators=[Optional(), Length(max=10)])  # YYYY-MM-DD
    support_end_date = StringField('Support End Date', validators=[Optional(), Length(max=10)])
    notes = TextAreaField('Notes', validators=[Optional(), Length(max=1000)])

    def populate_from_version(self, pv):
        self.product_id.data = str(pv.product_id)
        self.version.data = pv.version
        self.release_date.data = pv.release_date.strftime('%Y-%m-%d') if pv.release_date else ''
        self.support_end_date.data = pv.support_end_date.strftime('%Y-%m-%d') if pv.support_end_date else ''
        self.notes.data = pv.notes

    def populate_version(self, pv):
        pv.product_id = int(self.product_id.data)
        pv.version = self.version.data
        from datetime import datetime
        if self.release_date.data:
            try:
                pv.release_date = datetime.strptime(self.release_date.data, '%Y-%m-%d').date()
            except ValueError:
                pass
        if self.support_end_date.data:
            try:
                pv.support_end_date = datetime.strptime(self.support_end_date.data, '%Y-%m-%d').date()
            except ValueError:
                pass
        pv.notes = self.notes.data or None

class ConfigurationForm(FlaskForm):
    agency_id = StringField('Agency', validators=[DataRequired(), Length(max=10)])
    function_id = StringField('Function', validators=[DataRequired(), Length(max=10)])
    component_id = StringField('Component', validators=[DataRequired(), Length(max=10)])
    status = StringField('Status', validators=[Optional(), Length(max=50)])
    deployment_date = StringField('Deployment Date', validators=[Optional(), Length(max=10)])
    version_label = StringField('Version Label', validators=[Optional(), Length(max=100)])
    implementation_notes = TextAreaField('Implementation Notes', validators=[Optional(), Length(max=1000)])
    security_review_date = StringField('Security Review Date', validators=[Optional(), Length(max=10)])
    additional_metadata = TextAreaField('Additional Metadata (JSON)', validators=[Optional(), Length(max=5000)])

    def populate_from_configuration(self, c):
        self.agency_id.data = str(c.agency_id)
        self.function_id.data = str(c.function_id)
        self.component_id.data = str(c.component_id)
        self.status.data = c.status
        self.deployment_date.data = c.deployment_date.strftime('%Y-%m-%d') if c.deployment_date else ''
        self.version_label.data = c.version_label
        self.implementation_notes.data = c.implementation_notes
        self.security_review_date.data = c.security_review_date.strftime('%Y-%m-%d') if c.security_review_date else ''
        if c.additional_metadata:
            import json
            try:
                self.additional_metadata.data = json.dumps(c.additional_metadata, indent=2)
            except Exception:
                self.additional_metadata.data = ''

    def populate_configuration(self, c):
        c.agency_id = int(self.agency_id.data)
        c.function_id = int(self.function_id.data)
        c.component_id = int(self.component_id.data)
        c.status = self.status.data or 'Active'
        from datetime import datetime
        if self.deployment_date.data:
            try:
                c.deployment_date = datetime.strptime(self.deployment_date.data, '%Y-%m-%d').date()
            except ValueError:
                pass
        c.version_label = self.version_label.data or None
        c.implementation_notes = self.implementation_notes.data or None
        if self.security_review_date.data:
            try:
                c.security_review_date = datetime.strptime(self.security_review_date.data, '%Y-%m-%d').date()
            except ValueError:
                pass
        if self.additional_metadata.data:
            import json
            try:
                c.additional_metadata = json.loads(self.additional_metadata.data)
            except Exception:
                c.additional_metadata = None
        else:
            c.additional_metadata = None

class ConfigurationProductForm(FlaskForm):
    configuration_id = StringField('Configuration', validators=[Optional(), Length(max=10)])  # may come from URL
    product_id = StringField('Product', validators=[DataRequired(), Length(max=10)])
    product_version_id = StringField('Product Version', validators=[Optional(), Length(max=10)])
    status = StringField('Status', validators=[Optional(), Length(max=50)])
    deployment_date = StringField('Deployment Date', validators=[Optional(), Length(max=10)])
    settings = TextAreaField('Settings (JSON)', validators=[Optional(), Length(max=5000)])

    def populate_from_configuration_product(self, cp):
        self.configuration_id.data = str(cp.configuration_id)
        self.product_id.data = str(cp.product_id)
        self.product_version_id.data = str(cp.product_version_id) if cp.product_version_id else ''
        self.status.data = cp.status
        self.deployment_date.data = cp.deployment_date.strftime('%Y-%m-%d') if cp.deployment_date else ''
        if cp.settings:
            import json
            try:
                self.settings.data = json.dumps(cp.settings, indent=2)
            except Exception:
                self.settings.data = ''

    def populate_configuration_product(self, cp):
        if self.configuration_id.data:
            cp.configuration_id = int(self.configuration_id.data)
        cp.product_id = int(self.product_id.data)
        cp.product_version_id = self.product_version_id.data if self.product_version_id.data else None
        cp.status = self.status.data or 'Active'
        from datetime import datetime
        if self.deployment_date.data:
            try:
                cp.deployment_date = datetime.strptime(self.deployment_date.data, '%Y-%m-%d').date()
            except ValueError:
                pass
        if self.settings.data:
            import json
            try:
                cp.settings = json.loads(self.settings.data)
            except Exception:
                cp.settings = None
        else:
            cp.settings = None

# =============================
# End Phase 3 additions
# =============================
# End of app/forms/forms.py

# Start of app/agents/__init__.py
# app/agents/__init__.py
"""
Agent infrastructure for automated data gathering and enrichment.

Agents use LLM providers with web search to research entities and propose
database updates. Results are returned for human review before committing.

Usage:
    from app.agents import agency_agent
    
    result = agency_agent.execute({'name': 'TriMet'})
    if result.success:
        # Review result.draft, result.diff, result.skipped_fields
        # Then commit if approved
"""

from .base import BaseAgent, AgentResult, LogEntry
from .providers import get_provider, LLMProvider
from .tools import get_tool_registry, register_tool, Tool, ToolResult

# Import agents (this also registers their tools)
from .agency_agent import agency_agent, AgencyAgent

__all__ = [
    # Base classes
    'BaseAgent',
    'AgentResult', 
    'LogEntry',
    
    # Providers
    'get_provider',
    'LLMProvider',
    
    # Tools
    'get_tool_registry',
    'register_tool',
    'Tool',
    'ToolResult',
    
    # Agents
    'agency_agent',
    'AgencyAgent',
]
# End of app/agents/__init__.py

# Start of app/agents/agency_agent.py
# app/agents/agency_agent.py
"""
Agency Agent - builds or updates transit agency records using LLM with web search.
"""

from typing import Any

from .base import BaseAgent, AgentResult


# Schema for structured agency data extraction
AGENCY_SCHEMA = {
    'type': 'object',
    'properties': {
        'name': {'type': 'string', 'description': 'Official agency name'},
        'short_name': {'type': 'string', 'description': 'Short name/acronym (e.g., WMATA, BART)'},
        'location': {'type': 'string', 'description': 'City and state (e.g., Portland, Oregon)'},
        'description': {'type': 'string', 'description': 'Brief description of the agency (1-2 sentences)'},
        'website': {'type': 'string', 'description': 'Official website URL'},
        'ceo': {'type': 'string', 'description': 'Current CEO/General Manager/Executive Director name'},
        'address_hq': {'type': 'string', 'description': 'Headquarters address'},
        'phone_number': {'type': 'string', 'description': 'Main phone number'},
        'contact_email': {'type': 'string', 'description': 'General contact email'},
        'transit_map_link': {'type': 'string', 'description': 'URL to system map'},
        'email_domain': {'type': 'string', 'description': 'Agency email domain (e.g., trimet.org)'},
        'confidence': {
            'type': 'object',
            'description': 'Confidence scores (0-1) for each field',
            'properties': {
                'name': {'type': 'number'},
                'short_name': {'type': 'number'},
                'location': {'type': 'number'},
                'description': {'type': 'number'},
                'website': {'type': 'number'},
                'ceo': {'type': 'number'},
                'address_hq': {'type': 'number'},
                'phone_number': {'type': 'number'},
                'contact_email': {'type': 'number'},
                'transit_map_link': {'type': 'number'},
                'email_domain': {'type': 'number'},
            },
        },
    },
    'required': ['name', 'confidence'],
}


SEARCH_SYSTEM_PROMPT = """You are a research assistant gathering information about public transit agencies.

Your task is to find accurate, current information about the specified transit agency. Focus on:
1. Official name and common abbreviations
2. Headquarters location and address
3. Current leadership (CEO/General Manager/Executive Director)
4. Official website and contact information
5. System description

Use web search to find the most up-to-date information. Prioritize official sources (.gov domains, 
the agency's own website, official press releases) over third-party sources.

Be thorough but concise. If you cannot find certain information with confidence, note that."""


EXTRACTION_SYSTEM_PROMPT = """You are a data extraction assistant. Your job is to extract structured 
information about a transit agency from the provided research text.

Extract the following fields if available:
- name: The official full name of the agency
- short_name: Common abbreviation or acronym (e.g., BART, WMATA, TriMet)
- location: City and state where the agency is headquartered
- description: A brief 1-2 sentence description of what the agency operates
- website: The official website URL (must start with http:// or https://)
- ceo: The current CEO, General Manager, or Executive Director's full name
- address_hq: Full headquarters mailing address
- phone_number: Main contact phone number
- contact_email: General contact email address
- transit_map_link: URL to the system/route map
- email_domain: The domain used for agency emails (e.g., trimet.org)

For each field, also provide a confidence score from 0 to 1:
- 1.0: Found on official source, very confident
- 0.8-0.9: Found on reliable source, confident
- 0.5-0.7: Found but uncertain or potentially outdated
- Below 0.5: Guessed or very uncertain

If a field cannot be determined, omit it from the response (don't include null values).
Only include the confidence object with scores for fields you did include."""


class AgencyAgent(BaseAgent):
    """Agent for creating and updating transit agency records."""
    
    @property
    def agent_type(self) -> str:
        return 'agency'
    
    def execute(self, input_data: dict, existing_record: Any | None = None) -> AgentResult:
        """
        Execute agency research and data extraction.
        
        Args:
            input_data: {'name': 'Agency Name'} - the agency to research
            existing_record: Optional Agency model instance for updates
            
        Returns:
            AgentResult with draft agency data
        """
        self._logs = []  # Reset logs for new execution
        
        agency_name = input_data.get('name', '').strip()
        if not agency_name:
            return self._create_result(
                success=False,
                error='Agency name is required',
            )
        
        self._log('decision', {'action': 'start', 'agency_name': agency_name})
        
        try:
            # Step 1: Research the agency using web search
            research_text = self._research_agency(agency_name)
            
            if not research_text:
                return self._create_result(
                    success=False,
                    error='Failed to gather agency information',
                )
            
            # Step 2: Extract structured data
            extracted = self._extract_agency_data(agency_name, research_text)
            
            if '_parse_error' in extracted:
                self._log('error', {
                    'stage': 'extraction',
                    'error': extracted.get('_parse_error'),
                })
                return self._create_result(
                    success=False,
                    error=f"Failed to parse extracted data: {extracted.get('_parse_error')}",
                )
            
            # Step 3: Apply confidence filtering
            confidences = extracted.pop('confidence', {})
            draft, skipped = self._filter_by_confidence(extracted, confidences)
            
            # Step 4: Try to fetch logo if we have a website
            if draft.get('website'):
                self._fetch_agency_images(draft)
            
            # Step 5: Compute diff if updating
            diff = None
            is_update = existing_record is not None
            
            if is_update:
                existing_data = self._record_to_dict(existing_record)
                diff = self._compute_diff(existing_data, draft)
                self._log('decision', {
                    'action': 'computed_diff',
                    'changed_fields': list(diff.keys()),
                })
            
            result = self._create_result(
                success=True,
                draft=draft,
                skipped_fields=skipped,
                diff=diff,
                is_update=is_update,
            )
            
            # Save audit log
            self._save_audit_log(result, input_data)
            
            return result
            
        except Exception as e:
            self._log('error', {'stage': 'execution', 'error': str(e)})
            return self._create_result(
                success=False,
                error=str(e),
            )
    
    def _research_agency(self, agency_name: str) -> str | None:
        """Use LLM with web search to research the agency."""
        messages = [
            {
                'role': 'user',
                'content': f"""Research the public transit agency: "{agency_name}"

Find and summarize:
1. Official name and any common abbreviations
2. Location (city, state)
3. What type of transit they operate (bus, rail, ferry, etc.)
4. Current CEO/General Manager/Executive Director
5. Official website
6. Headquarters address and contact information
7. Any other relevant details

Provide a comprehensive summary of your findings.""",
            }
        ]
        
        response = self._call_llm(messages, SEARCH_SYSTEM_PROMPT, use_search=True)
        return response.content if response else None
    
    def _extract_agency_data(self, agency_name: str, research_text: str) -> dict:
        """Extract structured data from research text."""
        messages = [
            {
                'role': 'user',
                'content': f"""Based on the following research about "{agency_name}", extract structured data.

RESEARCH:
{research_text}

Extract the agency information into the required JSON format with confidence scores.""",
            }
        ]
        
        return self._call_llm_structured(messages, EXTRACTION_SYSTEM_PROMPT, AGENCY_SCHEMA)
    
    def _fetch_agency_images(self, draft: dict) -> None:
        """Attempt to fetch logo and header images."""
        website = draft.get('website')
        short_name = draft.get('short_name') or draft.get('name', 'agency')
        
        # Fetch logo
        logo_result = self._call_tool('image_fetch', {
            'entity_type': 'agency',
            'entity_name': draft.get('name', ''),
            'short_name': short_name,
            'website_url': website,
            'image_type': 'logo',
        })
        
        if logo_result.success:
            draft['_logo_fetched'] = True
            draft['_logo_path'] = logo_result.data.get('filepath')
        
        # Fetch header
        header_result = self._call_tool('image_fetch', {
            'entity_type': 'agency',
            'entity_name': draft.get('name', ''),
            'short_name': short_name,
            'website_url': website,
            'image_type': 'header',
        })
        
        if header_result.success:
            draft['_header_fetched'] = True
            draft['_header_path'] = header_result.data.get('filepath')
    
    def _record_to_dict(self, record) -> dict:
        """Convert an Agency model instance to a dict for comparison."""
        return {
            'name': record.name,
            'short_name': record.short_name,
            'location': record.location,
            'description': record.description,
            'website': record.website,
            'ceo': record.ceo,
            'address_hq': record.address_hq,
            'phone_number': record.phone_number,
            'contact_email': record.contact_email,
            'transit_map_link': record.transit_map_link,
            'email_domain': record.email_domain,
        }


# Singleton instance for easy import
agency_agent = AgencyAgent()
# End of app/agents/agency_agent.py

# Start of app/templates/base.html
<!-- app/templates/base.html -->

<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <title>{{ title|default("See-Tran - Transit System Intelligence") }}</title>
  <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
  <link rel="stylesheet" href="{{ url_for("static", filename="css/tailwind.css") }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .glass-effect { 
      backdrop-filter: blur(10px); 
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.1);
    }
    .glow-effect {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
    }
    .nav-link {
      position: relative;
      transition: all 0.3s ease;
    }
    .nav-link::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 0;
      width: 0;
      height: 2px;
      background: linear-gradient(90deg, #3b82f6, #06b6d4);
      transition: width 0.3s ease;
    }
    .nav-link:hover::after {
      width: 100%;
    }
    .metric-card {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(51, 65, 85, 0.9) 100%);
      transition: all 0.3s ease;
    }
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white">
  
  <!-- Navigation -->
<nav class="glass-effect border-b border-slate-700/50 sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      <!-- Logo and Brand -->
      <div class="flex-shrink-0">
        <a href="/" class="flex items-center space-x-3 group hover:opacity-90 transition-opacity">
          <div class="w-8 h-8 rounded-lg flex items-center justify-center">
            <img src="{{ url_for('static', filename='images/logo.png') }}" 
                 alt="SeeTran Logo" 
                 class="w-5 h-5 object-contain">
          </div>
          <div>
            <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">
              see-tran
            </h1>
          </div>
        </a>
      </div>

      <!-- Navigation: Hamburger Menu -->
      <div class="relative">
        <button id="menuButton" class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700/50 transition-colors" aria-haspopup="true" aria-expanded="false" aria-controls="menuPanel">
          <svg id="menuIconOpen" class="w-5 h-5 text-slate-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
          <svg id="menuIconClose" class="w-5 h-5 text-slate-200 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>

        <div id="menuPanel" class="hidden absolute right-0 mt-2 w-72 glass-effect rounded-xl border border-slate-700/50 shadow-xl overflow-hidden">
          <div class="p-2">
            <nav class="space-y-1">
              <a href="/" class="block px-3 py-2 rounded text-slate-200 hover:text-white hover:bg-slate-700/40 text-sm">Dashboard</a>
              <a href="/agencies" class="block px-3 py-2 rounded text-slate-200 hover:text-white hover:bg-slate-700/40 text-sm">Agencies</a>
              <a href="/functional-areas" class="block px-3 py-2 rounded text-slate-200 hover:text-white hover:bg-slate-700/40 text-sm">Functions</a>
              <a href="/components" class="block px-3 py-2 rounded text-slate-200 hover:text-white hover:bg-slate-700/40 text-sm">Components</a>
              <a href="/configurations" class="block px-3 py-2 rounded text-slate-200 hover:text-white hover:bg-slate-700/40 text-sm">Configurations</a>
              <a href="/products" class="block px-3 py-2 rounded text-slate-200 hover:text-white hover:bg-slate-700/40 text-sm">Products</a>
              <a href="/vendors" class="block px-3 py-2 rounded text-slate-200 hover:text-white hover:bg-slate-700/40 text-sm">Vendors</a>
              <a href="/integrations" class="block px-3 py-2 rounded text-slate-200 hover:text-white hover:bg-slate-700/40 text-sm">Integrations</a>
              <a href="/reports" class="block px-3 py-2 rounded text-slate-200 hover:text-white hover:bg-slate-700/40 text-sm">Reports</a>
              <a href="{{ url_for('main.docs_index') }}" class="block px-3 py-2 rounded text-slate-200 hover:text-white hover:bg-slate-700/40 text-sm">Docs</a>
              {% if session.get('user') and session['user'].get('is_super_admin') %}
              <a href="/admin" class="block px-3 py-2 rounded text-amber-300 hover:text-amber-200 hover:bg-slate-700/40 text-sm">Admin</a>
              {% endif %}

              <div class="border-t border-slate-700/50 my-2"></div>

              {% if session.get('user') %}
                <div class="px-3 py-1 text-xs text-slate-400">Signed in as {{ session['user']['email'] }}</div>
                <a href="{{ url_for('auth.logout') }}" class="block px-3 py-2 rounded text-red-300 hover:text-red-200 hover:bg-slate-700/40 text-sm">Logout</a>
              {% else %}
                <a href="{{ url_for('auth.login_page') }}" class="block px-3 py-2 rounded text-slate-200 hover:text-white hover:bg-slate-700/40 text-sm">Login</a>
              {% endif %}
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</nav>

  <!-- Main Content -->
  <main class="min-h-screen">
    {% block content %}{% endblock %}
  </main>

  <!-- Footer -->
  <footer class="glass-effect border-t border-slate-700/50 mt-auto">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="text-slate-400 text-sm">
          SeeTran Platform. Transit system visibility and intelligence.
        </div>
        <div class="flex space-x-6 mt-4 md:mt-0 items-center">
          <a href="#" class="text-slate-400 hover:text-slate-300 text-sm">Documentation</a>
          <a href="#" class="text-slate-400 hover:text-slate-300 text-sm">API</a>
          <a href="#" class="text-slate-400 hover:text-slate-300 text-sm">Support</a>
          <a href="/contribute" class="inline-flex items-center text-emerald-400 hover:text-emerald-300 text-sm font-medium">
            🌐 Open Source <span class="hidden sm:inline">&nbsp;| See how it works</span>
          </a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="{{ url_for("static", filename="js/htmx.min.js") }}"></script>
  <script src="{{ url_for("static", filename="js/main.js") }}"></script>
  <script>
    // Add smooth scroll behavior
    document.documentElement.style.scrollBehavior = 'smooth';
    
    // Add loading states for HTMX requests
    document.body.addEventListener('htmx:beforeRequest', function(e) {
      const target = e.target;
      if (target.classList.contains('btn-loading')) {
        target.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>';
      }
    });

    // Hamburger menu toggle
    (function(){
      const btn = document.getElementById('menuButton');
      const panel = document.getElementById('menuPanel');
      const iconOpen = document.getElementById('menuIconOpen');
      const iconClose = document.getElementById('menuIconClose');

      function closeMenu(){
        if (!panel) return;
        panel.classList.add('hidden');
        if (btn) btn.setAttribute('aria-expanded', 'false');
        if (iconOpen && iconClose){ iconOpen.classList.remove('hidden'); iconClose.classList.add('hidden'); }
      }

      function openMenu(){
        if (!panel) return;
        panel.classList.remove('hidden');
        if (btn) btn.setAttribute('aria-expanded', 'true');
        if (iconOpen && iconClose){ iconOpen.classList.add('hidden'); iconClose.classList.remove('hidden'); }
      }

      function toggleMenu(){
        if (!panel) return;
        if (panel.classList.contains('hidden')) openMenu(); else closeMenu();
      }

      if (btn){
        btn.addEventListener('click', function(e){ e.stopPropagation(); toggleMenu(); });
      }

      // Close on outside click
      document.addEventListener('click', function(e){
        if (!panel || panel.classList.contains('hidden')) return;
        if (!panel.contains(e.target) && !btn.contains(e.target)) closeMenu();
      });

      // Close on Escape
      document.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeMenu(); });
    })();
  </script>
  {% block scripts %}{% endblock %}
</body>
</html>
# End of app/templates/base.html

# Start of app/templates/index.html
<!-- app/templates/index.html -->

{% extends "base.html" %}
{% block content %}

<!-- Hero Section -->
<div class="relative overflow-hidden">
  <div class="absolute inset-0 bg-gradient-to-r from-blue-600/20 to-cyan-600/20"></div>
  <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <div class="text-center">
      <h1 class="text-4xl md:text-6xl font-bold mb-6">
        <span class="bg-gradient-to-r from-blue-400 via-cyan-400 to-teal-400 bg-clip-text text-transparent">
          Transit System
        </span>
        <br>
        <span class="text-white">Intelligence Platform</span>
      </h1>
      <p class="text-xl text-slate-300 mb-8 max-w-3xl mx-auto">
        Comprehensive visibility into public transit system infrastructure, vendor relationships, 
        and system integrations in real-time.
      </p>
      <div class="flex flex-col sm:flex-row justify-center gap-4">
        <button hx-get="/api/health" hx-swap="innerHTML" hx-target="#health-demo" 
                class="px-8 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-lg font-semibold 
                       hover:from-blue-700 hover:to-cyan-700 transition-all glow-effect">
          Test System Health
        </button>
        <a href="{{ url_for('main.docs_index') }}" class="px-8 py-3 border border-slate-600 rounded-lg font-semibold hover:bg-slate-800 transition-all inline-flex items-center justify-center">
          View the Docs
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Dashboard Content -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
  
  <!-- Metrics Overview -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
    
    <!-- Transit Agency Card -->
    <a href="{{ url_for('agency.index') }}" aria-label="View Agencies" class="block focus:outline-none focus:ring-2 focus:ring-cyan-500/50 rounded-xl">
      <div class="metric-card rounded-xl p-6 border border-slate-700/50">
        <div class="flex items-center justify-between mb-4">
          <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
            </svg>
          </div>
          <span class="text-2xl font-bold text-white" hx-get="/api/count/agencies" hx-trigger="load">0</span>
        </div>
        <h3 class="text-slate-400 text-sm font-medium mb-1">Transit Agencies</h3>
        <p class="text-xs text-slate-500">Active transportation networks</p>
      </div>
    </a>

    <!-- Vendors Card (renamed from Functional Areas) -->
    <a href="{{ url_for('main.vendors_page') }}" aria-label="View Vendors" class="block focus:outline-none focus:ring-2 focus:ring-cyan-500/50 rounded-xl">
      <div class="metric-card rounded-xl p-6 border border-slate-700/50">
        <div class="flex items-center justify-between mb-4">
          <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
          </div>
          <span class="text-2xl font-bold text-white" hx-get="/api/count/vendors" hx-trigger="load">0</span>
        </div>
        <h3 class="text-slate-400 text-sm font-medium mb-1">Vendors</h3>
        <p class="text-xs text-slate-500">Operational domains</p>
      </div>
    </a>

    <!-- Active Components Card -->
    <a href="{{ url_for('main.components_page') }}" aria-label="View Components" class="block focus:outline-none focus:ring-2 focus:ring-cyan-500/50 rounded-xl">
      <div class="metric-card rounded-xl p-6 border border-slate-700/50">
        <div class="flex items-center justify-between mb-4">
          <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"/>
            </svg>
          </div>
          <span class="text-2xl font-bold text-white" hx-get="/api/count/components" hx-trigger="load">0</span>
        </div>
        <h3 class="text-slate-400 text-sm font-medium mb-1">Active Components</h3>
        <p class="text-xs text-slate-500">Deployed technology components</p>
      </div>
    </a>

    <!-- Products Card (renamed from Integration Points) -->
    <a href="{{ url_for('configurations.products_page') }}" aria-label="View Products" class="block focus:outline-none focus:ring-2 focus:ring-cyan-500/50 rounded-xl">
      <div class="metric-card rounded-xl p-6 border border-slate-700/50">
        <div class="flex items-center justify-between mb-4">
          <div class="w-10 h-10 bg-gradient-to-r from-cyan-500 to-cyan-600 rounded-lg flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"/>
            </svg>
          </div>
          <span class="text-2xl font-bold text-white" hx-get="/api/count/products" hx-trigger="load">0</span>
        </div>
        <h3 class="text-slate-400 text-sm font-medium mb-1">Products</h3>
        <p class="text-xs text-slate-500">System interconnections</p>
      </div>
    </a>
  </div>

  <!-- Main Content Area -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <!-- System Status Panel -->
    <div class="lg:col-span-2">
      <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-semibold text-white">System Status</h2>
          <div class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
            <span class="text-sm text-slate-300">All Systems Operational</span>
          </div>
        </div>
        
        <!-- Demo System Status -->
        <div class="space-y-4">
          <div class="flex items-center justify-between p-4 bg-slate-800/50 rounded-lg border border-slate-700/30">
            <div class="flex items-center space-x-4">
              <div class="w-3 h-3 bg-green-500 rounded-full"></div>
              <div>
                <h4 class="font-medium text-white">Database Connection</h4>
                <p class="text-sm text-slate-400">SQLite • Local Development</p>
              </div>
            </div>
            <div class="text-right">
              <p class="text-sm text-green-400">Online</p>
              <p class="text-xs text-slate-500">Response: 2ms</p>
            </div>
          </div>

          <div class="flex items-center justify-between p-4 bg-slate-800/50 rounded-lg border border-slate-700/30">
            <div class="flex items-center space-x-4">
              <div class="w-3 h-3 bg-green-500 rounded-full"></div>
              <div>
                <h4 class="font-medium text-white">Web Server</h4>
                <p class="text-sm text-slate-400">Flask Development Server</p>
              </div>
            </div>
            <div class="text-right">
              <p class="text-sm text-green-400">Online</p>
              <p class="text-xs text-slate-500">Port: 5000</p>
            </div>
          </div>

          <div class="flex items-center justify-between p-4 bg-slate-800/50 rounded-lg border border-slate-700/30">
            <div class="flex items-center space-x-4">
              <div class="w-3 h-3 bg-green-500 rounded-full"></div>
              <div>
                <h4 class="font-medium text-white">HTMX Integration</h4>
                <p class="text-sm text-slate-400">Dynamic UI Updates</p>
              </div>
            </div>
            <div class="text-right">
              <p class="text-sm text-green-400">Active</p>
              <p class="text-xs text-slate-500">v2.0.4</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      
      <!-- System Health Demo -->
      <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4">System Health</h3>
        <div id="health-demo" class="text-center">
          <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
          </div>
          <h4 class="text-lg font-semibold text-white mb-2">Excellent</h4>
          <p class="text-sm text-slate-400">All systems functioning normally</p>
        </div>
      </div>

      <!-- Getting Started -->
      <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4">Getting Started</h3>
        <div class="space-y-3">
          <div class="flex items-center space-x-3 p-3 bg-slate-800/30 rounded-lg">
            <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
              <span class="text-xs font-bold text-white">1</span>
            </div>
            <p class="text-sm text-slate-300">Add your first transit agency</p>
          </div>
          <div class="flex items-center space-x-3 p-3 bg-slate-800/30 rounded-lg">
            <div class="w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center flex-shrink-0">
              <span class="text-xs font-bold text-white">2</span>
            </div>
            <p class="text-sm text-slate-300">Define functional areas</p>
          </div>
          <div class="flex items-center space-x-3 p-3 bg-slate-800/30 rounded-lg">
            <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
              <span class="text-xs font-bold text-white">3</span>
            </div>
            <p class="text-sm text-slate-300">Configure system integration</p>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4">Quick Actions</h3>
        <div class="space-y-3">
          <button class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-lg text-sm font-medium hover:from-blue-700 hover:to-cyan-700 transition-all">
            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
            </svg>
            Add Transit Agency
          </button>
          <button class="w-full px-4 py-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm font-medium transition-colors">
            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
              <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a2 2 0 00-2 2v6a2 2 0 002 2h8a2 2 0 002-2V6a2 2 0 00-2-2V3a2 2 0 012 2v8a4 4 0 01-4 4H6a4 4 0 01-4-4V5z" clip-rule="evenodd"/>
            </svg>
            Generate Report
          </button>
          <button class="w-full px-4 py-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm font-medium transition-colors">
            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
            Export Data
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Information Cards -->
  <div class="mt-12 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
      <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mb-4">
        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
          <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-white mb-2">System Tracking</h3>
      <p class="text-slate-400 text-sm">Monitor all your transit technology components, versions, and deployment status in one centralized dashboard.</p>
    </div>

    <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
      <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg flex items-center justify-center mb-4">
        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
          <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-white mb-2">Vendor Management</h3>
      <p class="text-slate-400 text-sm">Track vendor relationships, contact information, and system dependencies across your entire transit network.</p>
    </div>

    <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
      <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center mb-4">
        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"/>
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-white mb-2">Integration Mapping</h3>
      <p class="text-slate-400 text-sm">Visualize system integrations, data flows, and interconnections to understand your technology ecosystem.</p>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Auto-refresh metrics every 30 seconds
setInterval(function() {
  const elements = document.querySelectorAll('[hx-get*="/api/count/"]');
  elements.forEach(el => htmx.trigger(el, 'refresh'));
}, 30000);

// Add smooth animations for loaded content
document.body.addEventListener('htmx:afterSwap', function(e) {
  const newContent = e.detail.target;
  newContent.style.opacity = '0';
  newContent.style.transform = 'translateY(10px)';
  
  setTimeout(() => {
    newContent.style.transition = 'all 0.3s ease';
    newContent.style.opacity = '1';
    newContent.style.transform = 'translateY(0)';
  }, 50);
});
</script>
{% endblock %}
# End of app/templates/index.html

# Start of app/templates/vendors.html
<!-- app/templates/vendors.html -->

{% extends "base.html" %}
{% block content %}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  
  <!-- Page Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-white mb-2">Vendor Management</h1>
    <p class="text-slate-400">Manage vendor relationships and track system portfolios across your transit network.</p>
  </div>

  <!-- Stats Overview -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
      <div class="flex items-center justify-between mb-2">
        <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
          </svg>
        </div>
        <span class="text-2xl font-bold text-white" hx-get="/api/count/vendors" hx-trigger="load">--</span>
      </div>
      <h3 class="text-slate-400 text-sm font-medium">Total Vendors</h3>
    </div>

    <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
      <div class="flex items-center justify-between mb-2">
        <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
        </div>
        <span class="text-2xl font-bold text-white" id="active-vendors-count">--</span>
      </div>
      <h3 class="text-slate-400 text-sm font-medium">Active Vendors</h3>
    </div>

    <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
      <div class="flex items-center justify-between mb-2">
        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
          </svg>
        </div>
        <span class="text-2xl font-bold text-white" id="avg-systems-count">--</span>
      </div>
      <h3 class="text-slate-400 text-sm font-medium">Avg Systems/Vendor</h3>
    </div>

    <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
      <div class="flex items-center justify-between mb-2">
        <div class="w-10 h-10 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
          </svg>
        </div>
        <span class="text-2xl font-bold text-white" id="top-vendor-count">--</span>
      </div>
      <h3 class="text-slate-400 text-sm font-medium">Top Vendor Systems</h3>
    </div>
  </div>

  <!-- Enhanced Search and Filters -->
  <div class="glass-effect rounded-xl p-6 border border-slate-700/50 mb-8" id="vendor-filters-container">
    <form id="vendor-filters" class="space-y-4">
      
      <!-- Main Filter Row -->
      <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center">
        
        <!-- Search Input -->
        <div class="relative flex-1 max-w-md">
          <input type="text" 
                 id="vendor-search" 
                 name="search"
                 placeholder="Search vendors..." 
                 class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 pl-10 text-white placeholder-slate-400 focus:border-purple-500 focus:ring-1 focus:ring-purple-500 focus:outline-none transition-colors"
                 hx-get="/api/vendors/list" 
                 hx-target="#vendors-list" 
                 hx-trigger="keyup changed delay:300ms" 
                 hx-include="#vendor-filters">
          <svg class="absolute left-3 top-3 w-4 h-4 text-slate-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
          </svg>
        </div>

        <!-- Agency Filter -->
        <div class="flex-1 max-w-xs">
          <select id="agency-filter" 
                  name="agency"
                  class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 focus:outline-none transition-colors"
                  hx-get="/api/vendors/list" 
                  hx-target="#vendors-list" 
                  hx-trigger="change" 
                  hx-include="#vendor-filters">
            <option value="">All Agencies</option>
            <!-- Options will be loaded dynamically -->
          </select>
        </div>

        <!-- Functional Area Filter -->
        <div class="flex-1 max-w-xs">
          <select id="functional-area-filter" 
                  name="functional_area"
                  class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors"
                  hx-get="/api/vendors/list" 
                  hx-target="#vendors-list" 
                  hx-trigger="change" 
                  hx-include="#vendor-filters">
            <option value="">All Functional Areas</option>
            <!-- Options will be loaded dynamically -->
          </select>
        </div>

        <!-- Sort Options -->
        <div class="flex-1 max-w-xs">
          <select id="sort-select" 
                  name="sort"
                  class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:border-green-500 focus:ring-1 focus:ring-green-500 focus:outline-none transition-colors"
                  hx-get="/api/vendors/list" 
                  hx-target="#vendors-list" 
                  hx-trigger="change" 
                  hx-include="#vendor-filters">
            <option value="name">Sort by Name</option>
            <option value="components">Sort by Component Count</option>
            <option value="recent">Sort by Recent Activity</option>
          </select>
        </div>
      </div>

      <!-- Active Filters and Actions Row -->
      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 pt-4 border-t border-slate-700/30">
        
        <!-- Active Filter Badges -->
        <div class="flex-1">
          <div class="flex items-center space-x-2">
            <span class="text-sm text-slate-400">Filters:</span>
            <div id="active-filters" class="flex flex-wrap gap-2">
              <!-- Filter badges will be populated by JavaScript -->
            </div>
            <button type="button" 
                    onclick="clearAllFilters('#vendor-filters', '#vendors-list')"
                    class="text-xs text-slate-500 hover:text-slate-300 transition-colors ml-2"
                    id="clear-filters-btn" style="display: none;">
              Clear All
            </button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-2">
          <button type="button"
                  hx-get="/api/vendors/form" 
                  hx-target="#vendor-details" 
                  hx-swap="innerHTML"
                  class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-medium hover:from-purple-700 hover:to-pink-700 transition-all text-white shadow-lg">
            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
            </svg>
            Add Vendor
          </button>
          
          <button type="button" 
                  class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg font-medium transition-colors text-white">
            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
              <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a2 2 0 00-2 2v6a2 2 0 002 2h8a2 2 0 002-2V6a2 2 0 00-2-2V3a2 2 0 012 2v8a4 4 0 01-4 4H6a4 4 0 01-4-4V5z" clip-rule="evenodd"/>
            </svg>
            Export List
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Main Content Area -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <!-- Vendors List -->
    <div class="lg:col-span-2">
      <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-semibold text-white">Vendor Portfolio</h2>
          <div class="flex items-center space-x-2 text-sm text-slate-400">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span id="vendor-count-display">Loading...</span>
          </div>
        </div>
        
        <div id="vendors-list" class="space-y-6" hx-get="/api/vendors/list" hx-trigger="load">
          <!-- Vendors will be loaded here -->
          <div class="animate-pulse space-y-6">
            <div class="h-32 bg-slate-800 rounded-lg"></div>
            <div class="h-32 bg-slate-800 rounded-lg"></div>
            <div class="h-32 bg-slate-800 rounded-lg"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6 sticky top-24 max-h-[calc(100vh-6rem)] overflow-y-auto">
      <!-- Vendor Details Panel -->
      <div id="vendor-details">
        <!-- Default state -->
        <div class="glass-effect rounded-xl p-6 border border-slate-700/50 text-center">
          <div class="w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-slate-500" fill="currentColor" viewBox="0 0 20 20">
              <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
            </svg>
          </div>
          <h3 class="text-lg font-medium text-slate-400 mb-2">Vendor Details</h3>
          <p class="text-slate-500 text-sm">Click on a vendor to view detailed information, system portfolio, and contact details.</p>
        </div>
      </div>

      <!-- Top Integration Standards -->
      <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4">Integration Standards</h3>
        <div id="integration-standards" hx-get="/api/integration/standards" hx-trigger="load" class="space-y-2">
          <!-- Integration standards will be loaded here -->
          <div class="animate-pulse space-y-2">
            <div class="h-6 bg-slate-800 rounded"></div>
            <div class="h-6 bg-slate-800 rounded"></div>
            <div class="h-6 bg-slate-800 rounded"></div>
          </div>
        </div>
      </div>

      <!-- Vendor Performance Insights -->
      <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4">Performance Insights</h3>
        <div class="space-y-3" id="performance-insights">
          <div class="flex justify-between items-center p-3 bg-slate-800/30 rounded-lg">
            <span class="text-slate-300 text-sm">Most Reliable</span>
            <span class="text-green-400 font-medium text-sm" id="most-reliable-vendor">--</span>
          </div>
          <div class="flex justify-between items-center p-3 bg-slate-800/30 rounded-lg">
            <span class="text-slate-300 text-sm">Newest Partnership</span>
            <span class="text-blue-400 font-medium text-sm" id="newest-vendor">--</span>
          </div>
          <div class="flex justify-between items-center p-3 bg-slate-800/30 rounded-lg">
            <span class="text-slate-300 text-sm">Most Systems</span>
            <span class="text-purple-400 font-medium text-sm" id="largest-vendor">--</span>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4">Quick Actions</h3>
        <div class="space-y-3">
          <button hx-get="/api/vendors/form" hx-target="#vendor-details" hx-swap="innerHTML"
                  class="w-full px-4 py-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg text-sm font-medium hover:from-purple-700 hover:to-pink-700 transition-all text-white shadow-lg">
            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
            </svg>
            Add New Vendor
          </button>
          <button class="w-full px-4 py-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm font-medium transition-colors">
            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
              <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a2 2 0 00-2 2v6a2 2 0 002 2h8a2 2 0 002-2V6a2 2 0 00-2-2V3a2 2 0 012 2v8a4 4 0 01-4 4H6a4 4 0 01-4-4V5z" clip-rule="evenodd"/>
            </svg>
            Vendor Report
          </button>
          <button class="w-full px-4 py-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm font-medium transition-colors">
            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
            Export Contacts
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// =============================================================================
// VENDOR PAGE STATE MANAGEMENT - Embedded Controller
// =============================================================================

class VendorPageController {
  constructor() {
    this.currentFilters = {
      search: '',
      agency: '',
      functional_area: '',
      sort: 'name'
    };
    this.selectedVendorId = null;
    this.isLoading = false;
    this.refreshTimers = [];
    
    this.init();
  }

  init() {
    this.setupEventListeners();
    this.loadInitialData();
    this.setupPeriodicRefresh();
    console.log('🏢 Vendor page controller initialized');
  }

  setupEventListeners() {
    const form = document.getElementById('vendor-filters');
    if (form) {
      form.addEventListener('input', this.handleFilterChange.bind(this));
      form.addEventListener('change', this.handleFilterChange.bind(this));
    }

    document.body.addEventListener('htmx:beforeRequest', this.handleBeforeRequest.bind(this));
    document.body.addEventListener('htmx:afterRequest', this.handleAfterRequest.bind(this));
    document.body.addEventListener('htmx:afterSwap', this.handleAfterSwap.bind(this));
    document.body.addEventListener('htmx:responseError', this.handleResponseError.bind(this));
  }

  async loadInitialData() {
    try {
      await Promise.all([
        this.loadFilterOptions(),
        this.loadVendorStats(),
        this.loadVendorPerformance()
      ]);
    } catch (error) {
      console.error('Error loading initial data:', error);
      showToast('Error loading page data. Please refresh.', false);
    }
  }

  async loadFilterOptions() {
    try {
      const agencyResponse = await fetch('/api/vendors/filter-options/agencies');
      const agencyHtml = await agencyResponse.text();
      const agencySelect = document.getElementById('agency-filter');
      if (agencySelect) agencySelect.innerHTML = agencyHtml;

      const faResponse = await fetch('/api/vendors/filter-options/functional-areas');
      const faHtml = await faResponse.text();
      const faSelect = document.getElementById('functional-area-filter');
      if (faSelect) faSelect.innerHTML = faHtml;
    } catch (error) {
      console.error('Error loading filter options:', error);
    }
  }

  handleFilterChange(event) {
    const formData = new FormData(document.getElementById('vendor-filters'));
    const newFilters = {};
    
    for (const [key, value] of formData.entries()) {
      newFilters[key] = value.trim();
    }
    this.currentFilters = { ...this.currentFilters, ...newFilters };

    if (event.target.name === 'search') {
      clearTimeout(this.searchTimeout);
      this.searchTimeout = setTimeout(() => {
        this.refreshVendorList();
        this.updateActiveFilters();
      }, 300);
    } else {
      this.refreshVendorList();
      this.updateActiveFilters();
    }

    this.loadVendorStats();
    this.loadVendorPerformance();
  }

  refreshVendorList() {
    if (this.isLoading) return;
    
    const vendorsList = document.getElementById('vendors-list');
    if (vendorsList) {
      this.showListLoading(true);
      htmx.trigger(vendorsList, 'refresh');
    }
  }

  updateActiveFilters() {
    const filterContainer = document.getElementById('active-filters');
    const clearBtn = document.getElementById('clear-filters-btn');
    
    if (!filterContainer) return;
    
    filterContainer.innerHTML = '';
    let hasActiveFilters = false;
    
    Object.entries(this.currentFilters).forEach(([key, value]) => {
      if (value && value !== '' && key !== 'sort') {
        hasActiveFilters = true;
        
        let displayKey = key;
        if (key === 'functional_area') displayKey = 'functional area';
        
        const badge = document.createElement('span');
        badge.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-600/20 text-purple-300 border border-purple-600/30';
        badge.innerHTML = `
          ${displayKey}: ${value}
          <button onclick="vendorController.clearSpecificFilter('${key}')" class="ml-1 text-purple-400 hover:text-purple-200 transition-colors">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        `;
        filterContainer.appendChild(badge);
      }
    });
    
    if (clearBtn) {
      clearBtn.style.display = hasActiveFilters ? 'inline-block' : 'none';
    }
  }

  clearSpecificFilter(filterKey) {
    const form = document.getElementById('vendor-filters');
    if (form) {
      const element = form.querySelector(`[name="${filterKey}"]`);
      if (element) {
        element.value = '';
        this.currentFilters[filterKey] = '';
        this.refreshVendorList();
        this.updateActiveFilters();
        this.loadVendorStats();
        this.loadVendorPerformance();
      }
    }
  }

  clearAllFilters() {
    const form = document.getElementById('vendor-filters');
    if (form) {
      form.reset();
      this.currentFilters = { search: '', agency: '', functional_area: '', sort: 'name' };
      this.refreshVendorList();
      this.updateActiveFilters();
      this.loadVendorStats();
      this.loadVendorPerformance();
    }
  }

  async loadVendorStats() {
    try {
      const params = new URLSearchParams();
      Object.entries(this.currentFilters).forEach(([key, value]) => {
        if (value && value.trim() !== '') params.append(key, value.trim());
      });
      
      const response = await fetch('/api/vendors/stats?' + params.toString());
      const data = await response.json();
      
      if (data.status !== 'error') {
        document.getElementById('active-vendors-count').textContent = data.active_vendors;
        document.getElementById('avg-systems-count').textContent = data.avg_components_per_vendor;
        if (data.top_vendor) {
          document.getElementById('top-vendor-count').textContent = data.top_vendor.component_count;
        }
      }
    } catch (error) {
      console.error('Error loading vendor stats:', error);
    }
  }

  async loadVendorPerformance() {
    try {
      const params = new URLSearchParams();
      Object.entries(this.currentFilters).forEach(([key, value]) => {
        if (value && value.trim() !== '') params.append(key, value.trim());
      });
      
      const response = await fetch('/api/vendors/performance?' + params.toString());
      const data = await response.json();
      
      if (data.status !== 'error') {
        document.getElementById('most-reliable-vendor').textContent = data.most_reliable;
        document.getElementById('newest-vendor').textContent = data.newest;
        document.getElementById('largest-vendor').textContent = data.largest;
      }
    } catch (error) {
      console.error('Error loading vendor performance:', error);
    }
  }

  showListLoading(show) {
    const vendorsList = document.getElementById('vendors-list');
    if (!vendorsList) return;
    
    if (show) {
      vendorsList.style.opacity = '0.6';
      vendorsList.style.pointerEvents = 'none';
    } else {
      vendorsList.style.opacity = '1';
      vendorsList.style.pointerEvents = 'auto';
    }
  }

  updateVendorCount() {
    const metaElement = document.getElementById('vendor-list-meta');
    const countDisplay = document.getElementById('vendor-count-display');
    
    if (metaElement && countDisplay) {
      const count = parseInt(metaElement.dataset.count) || 0;
      countDisplay.textContent = `${count} vendor${count !== 1 ? 's' : ''} found`;
    }
  }

  setupPeriodicRefresh() {
    this.refreshTimers.push(
      setInterval(() => {
        const elements = document.querySelectorAll('[hx-get*="/api/count/"]');
        elements.forEach(el => htmx.trigger(el, 'refresh'));
      }, 30000)
    );
  }

  handleBeforeRequest(event) {
    if (event.target.id === 'vendors-list') {
      this.isLoading = true;
      this.showListLoading(true);
    }
  }

  handleAfterRequest(event) {
    if (event.target.id === 'vendors-list') {
      this.isLoading = false;
      this.showListLoading(false);
    }
  }

  handleAfterSwap(event) {
    if (event.target.id === 'vendors-list') {
      setTimeout(() => this.updateVendorCount(), 100);
      this.setupVendorCardEffects();
      if (this.selectedVendorId) {
        this.highlightSelectedVendor(this.selectedVendorId);
      }
    }
  }

  handleResponseError(event) {
    if (event.target.id === 'vendors-list') {
      this.isLoading = false;
      this.showListLoading(false);
      showToast('Error loading vendors. Please try again.', false);
    }
  }

  setupVendorCardEffects() {
    const vendorCards = document.querySelectorAll('.vendor-card');
    vendorCards.forEach(card => {
      card.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-4px)';
        this.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.3)';
      });
      
      card.addEventListener('mouseleave', function() {
        if (!this.classList.contains('selected')) {
          this.style.transform = 'translateY(0)';
          this.style.boxShadow = 'none';
        }
      });
      
      card.addEventListener('click', (e) => {
        if (!e.target.closest('a') && !e.target.closest('button')) {
          this.selectedVendorId = card.dataset.vendorId;
          this.highlightSelectedVendor(this.selectedVendorId);
        }
      });
    });
  }

  highlightSelectedVendor(vendorId) {
    document.querySelectorAll('.vendor-card').forEach(card => {
      card.classList.remove('selected');
      if (!card.matches(':hover')) {
        card.style.transform = 'translateY(0)';
        card.style.boxShadow = 'none';
      }
    });
    
    const selectedCard = document.querySelector(`[data-vendor-id="${vendorId}"]`);
    if (selectedCard) {
      selectedCard.classList.add('selected');
      selectedCard.style.transform = 'translateY(-4px)';
      selectedCard.style.boxShadow = '0 10px 25px rgba(147, 51, 234, 0.3)';
    }
  }

  closeVendorDetails() {
    this.selectedVendorId = null;
    document.getElementById('vendor-details').innerHTML = `
      <div class="glass-effect rounded-xl p-6 border border-slate-700/50 text-center">
        <div class="w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-slate-500" fill="currentColor" viewBox="0 0 20 20">
            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
          </svg>
        </div>
        <h3 class="text-lg font-medium text-slate-400 mb-2">Vendor Details</h3>
        <p class="text-slate-500 text-sm">Click on a vendor to view detailed information, system portfolio, and contact details.</p>
      </div>`;
  }
}

// =============================================================================
// GLOBAL FUNCTIONS AND INITIALIZATION
// =============================================================================

let vendorController;

function clearSpecificFilter(filterKey) {
  if (vendorController) vendorController.clearSpecificFilter(filterKey);
}

function clearAllFilters() {
  if (vendorController) vendorController.clearAllFilters();
}

function closeVendorDetails() {
  if (vendorController) vendorController.closeVendorDetails();
}

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', function() {
  vendorController = new VendorPageController();
  
  // Make functions globally available
  window.clearSpecificFilter = clearSpecificFilter;
  window.clearAllFilters = clearAllFilters;
  window.closeVendorDetails = closeVendorDetails;
  window.vendorController = vendorController;
});

// Enhanced form handling for vendor operations
document.body.addEventListener('htmx:afterRequest', function(e) {
  // Handle vendor form submissions
  if (e.target.id === 'vendor-form') {
    try {
      const response = JSON.parse(e.detail.xhr.response);
      
      if (response.status === 'success') {
        // Trigger custom events for vendor operations
        if (e.detail.requestConfig.path.includes('POST') && !e.detail.requestConfig.path.match(/\/\d+$/)) {
          // New vendor created
          document.dispatchEvent(new CustomEvent('vendor:created', { 
            detail: { message: response.message } 
          }));
        } else if (e.detail.requestConfig.path.includes('POST') && e.detail.requestConfig.path.match(/\/\d+$/)) {
          // Vendor updated
          const vendorId = e.detail.requestConfig.path.match(/\/(\d+)$/)[1];
          document.dispatchEvent(new CustomEvent('vendor:updated', { 
            detail: { vendorId: vendorId, message: response.message } 
          }));
        }
      }
    } catch (error) {
      // Response is not JSON, handle as before
    }
  }
});

// Handle vendor deletion
document.addEventListener('vendor:deleted', function(e) {
  if (vendorController) {
    vendorController.refreshVendorList();
    vendorController.loadVendorStats();
    vendorController.loadVendorPerformance();
    if (e.detail.vendorId === vendorController.selectedVendorId) {
      vendorController.closeVendorDetails();
    }
  }
});

// Export functionality
function exportVendorList() {
  showToast('Export functionality coming soon!', true);
}

window.exportVendorList = exportVendorList;
</script>
{% endblock %}
# End of app/templates/vendors.html

# Start of app/templates/components.html
{% extends "base.html" %}
{% block content %}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

  <!-- Page Header -->
  <div class="mb-6 sm:mb-8">
    <div class="flex items-center justify-between gap-3">
      <div>
        <h1 class="text-3xl sm:text-4xl font-extrabold text-white tracking-tight">Components</h1>
        <p class="text-slate-400 text-sm sm:text-base mt-1">Browse all transit technology components. Filter and tap a card to view full details.</p>
      </div>
      <div class="hidden sm:flex items-center gap-2">
        <a href="/vendors" class="px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm text-white border border-slate-700/60 transition-colors">Vendors</a>
        <a href="/functional-areas" class="px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm text-white border border-slate-700/60 transition-colors">Functional Areas</a>
      </div>
    </div>
  </div>

  <!-- Dynamic Component Form Container -->
  <div id="component-form-container" class="mb-8"></div>
  <!-- Added details container for component card clicks -->
  <div id="component-details" class="mb-8"></div>

  <!-- Filters -->
  <div class="glass-effect rounded-xl p-4 sm:p-5 border border-slate-700/50 mb-6 sm:mb-8">
    <!-- One form that drives all filtering -->
    <form id="component-filters"
          class="flex flex-col gap-3 lg:gap-4"
          hx-get="/api/components/list"
          hx-target="#components-list"
          hx-trigger="change, keyup delay:250ms from:#component-search"
          hx-swap="innerHTML transition:true"
          hx-push-url="true">
      
      <div class="flex flex-col lg:flex-row items-stretch lg:items-center justify-between gap-3 lg:gap-4">

        <!-- Left: search + dropdowns -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 lg:gap-4 w-full">

          <!-- Search -->
          <div class="relative col-span-1 sm:col-span-2 lg:col-span-2">
            <input id="component-search" name="search" type="text"
                   placeholder="Search components, vendors, or functions…"
                   class="w-full bg-slate-800 border border-slate-700 rounded-lg pl-10 pr-3 py-2.5 text-white placeholder-slate-400 focus:border-blue-500 focus:outline-none"
                   value="{{ request.args.get('search','') }}">
            <svg class="absolute left-3 top-2.5 w-5 h-5 text-slate-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
            </svg>
          </div>

          <!-- Agency -->
          <select id="agency-filter" name="agency"
                  class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-white focus:border-blue-500 focus:outline-none">
            <option value="">All Agencies</option>
          </select>

          <!-- Functional Area -->
          <select id="functional-area-filter" name="functional_area"
                  class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-white focus:border-blue-500 focus:outline-none">
            <option value="">All Functional Areas</option>
          </select>

          <!-- Vendor -->
          <select id="vendor-filter" name="vendor"
                  class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-white focus:border-blue-500 focus:outline-none">
            <option value="">All Vendors</option>
          </select>

          <!-- Status -->
          <select id="status-filter" name="status"
                  class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-white focus:border-blue-500 focus:outline-none">
            <option value="">All Components</option>
            <option value="no_issues">No Issues</option>
            <option value="issues">Has Issues</option>
          </select>
        </div>
      </div>

        <!-- Right: actions -->
      <div class="flex items-center gap-2 w-full lg:w-auto">
          <button type="button" id="filters-reset"
                  class="px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm text-white border border-slate-700/60 transition-colors">
            Reset
          </button>
          <button type="button"
                  class="px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm text-white border border-slate-700/60 transition-colors"
                  hx-get="/api/components/list" hx-target="#components-list" hx-swap="innerHTML">
            Refresh
          </button>
          <button type="button"
                  class="px-4 py-2.5 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-lg font-medium hover:from-blue-700 hover:to-cyan-700 transition-all text-white"
                  hx-get="/api/components/form" hx-target="#component-form-container" hx-swap="innerHTML">
            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
            </svg>
            Add Component
          </button>
          <button type="button" class="px-4 py-2.5 bg-slate-800 hover:bg-slate-700 rounded-lg font-medium transition-colors text-white">
            Export
          </button>
      </div>
    </form>
  </div>

  <!-- Components Grid -->
  <div class="glass-effect rounded-xl p-4 sm:p-6 border border-slate-700/50">
    <div class="flex items-center justify-between mb-4 sm:mb-6">
      <h2 class="text-xl sm:text-2xl font-bold text-white">Components</h2>
      <span id="result-count" class="text-xs sm:text-sm text-slate-400"></span>
    </div>

    <div id="components-list"
     class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-3 sm:gap-4 auto-rows-fr"
     hx-get="/api/components/list"
     hx-trigger="load"
     hx-include="#component-filters">
      <!-- Skeleton -->
      <div class="animate-pulse space-y-3 col-span-full">
        <div class="h-24 bg-slate-800 rounded-lg"></div>
        <div class="h-24 bg-slate-800 rounded-lg"></div>
        <div class="h-24 bg-slate-800 rounded-lg"></div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Populate dropdowns
  htmx.ajax('GET', '/api/filter-options/functional-areas', { target: '#functional-area-filter', swap: 'innerHTML' })
  htmx.ajax('GET', '/api/filter-options/vendors', { target: '#vendor-filter', swap: 'innerHTML' })
  htmx.ajax('GET', '/api/agencies/options', { target: '#agency-filter', swap: 'innerHTML' })

  // Restore selected values from query string (supports deep-linking)
  const params = new URLSearchParams(window.location.search)
  for (const [k, v] of params.entries()) {
    const el = document.querySelector(`[name="${CSS.escape(k)}"]`)
    if (el) el.value = v
  }

  // Reset filters
  document.getElementById('filters-reset').addEventListener('click', () => {
    const form = document.getElementById('component-filters')
    form.reset()
    // Also clear query string
    history.replaceState({}, '', window.location.pathname)
    htmx.trigger(form, 'change')
  })
})

// Optional: update visible count after each swap
document.body.addEventListener('htmx:afterSwap', function (evt) {
  if (evt.detail.target && evt.detail.target.id === 'components-list') {
    const count = evt.detail.target.querySelectorAll('[data-component-card="1"]').length
    const el = document.getElementById('result-count')
    if (el) el.textContent = count ? `${count} result${count === 1 ? '' : 's'}` : ''
  }
})

// Auto-refresh count metrics if present
setInterval(function() {
  const elements = document.querySelectorAll('[hx-get*="/api/count/"]')
  elements.forEach(el => htmx.trigger(el, 'refresh'))
}, 30000)
</script>
{% endblock %}

# End of app/templates/components.html

# Start of app/templates/functional_areas.html
<!-- app/templates/functional_areas.html -->

{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  
  <!-- Page Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-white mb-2">Functional Areas Management</h1>
    <p class="text-slate-400">Manage global functional areas that organize transit technology functions across all agencies.</p>
  </div>

  <!-- Actions Bar -->
  <div class="glass-effect rounded-xl p-6 border border-slate-700/50 mb-6">
    <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
      
      <!-- Filters -->
      <div class="flex flex-col sm:flex-row gap-4 flex-1">
        <!-- Search -->
        <div class="relative flex-1 max-w-md">
          <input type="text" id="area-search" placeholder="Search functional areas..." 
                 class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:border-blue-500 focus:outline-none"
                 hx-get="/api/functional-areas/list" hx-target="#functional-areas-list" hx-trigger="keyup changed delay:300ms" 
                 hx-vals="js:{search: event.target.value}">
          <svg class="absolute right-3 top-2.5 w-5 h-5 text-slate-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
          </svg>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex gap-2">
        <button hx-get="/api/functional-areas/form" hx-target="#functional-area-form-container" hx-swap="innerHTML"
                class="px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg font-medium hover:from-purple-700 hover:to-blue-700 transition-all">
          <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
          </svg>
          Add Functional Area
        </button>
        <a id="fa-export-btn"
           href="{{ url_for('main.export_functional_areas_excel') }}"
           class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg font-medium transition-colors"
           title="Download Excel export">
          Export
        </a>
        <a href="{{ url_for('main.functional_areas_print_page') }}" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg font-medium transition-colors" title="Open print-friendly Functional Areas view">
          Print Areas
        </a>
        <a href="{{ url_for('main.functions_print_page') }}" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg font-medium transition-colors" title="Open print-friendly Functions view grouped by area">
          Print Functions
        </a>
      </div>
    </div>
  </div>

  <!-- Inline Form Container -->
  <div id="functional-area-form-container" class="mb-6"></div>

  <!-- Functional Areas List (Full Width) -->
  <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-xl font-semibold text-white">Functional Areas</h2>
      <button hx-get="/api/functional-areas/list" hx-target="#functional-areas-list" 
              class="px-3 py-1 bg-slate-800 hover:bg-slate-700 rounded text-sm transition-colors">
        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
        </svg>
        Refresh
      </button>
    </div>
    
    <div id="functional-areas-list" hx-get="/api/functional-areas/list" hx-trigger="load">
      <!-- Functional areas will be loaded here -->
      <div class="animate-pulse space-y-4">
        <div class="h-24 bg-slate-800 rounded-lg"></div>
        <div class="h-24 bg-slate-800 rounded-lg"></div>
        <div class="h-24 bg-slate-800 rounded-lg"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Toggle inline details under a functional area card
function toggleFaDetails(id) {
  const target = document.getElementById(`fa-details-${id}`);
  if (!target) return;
  if (target.innerHTML && target.innerHTML.trim() !== '') {
    // Collapse
    target.innerHTML = '';
  } else {
    // Expand by fetching details
    htmx.ajax('GET', `/api/functional-areas/${id}/details`, { target: target, swap: 'innerHTML' });
  }
}

// Auto-refresh stats every 30 seconds (kept for future if needed)
setInterval(function() {
  const elements = document.querySelectorAll('[hx-get*="/api/count/"]');
  elements.forEach(el => htmx.trigger(el, 'refresh'));
}, 30000);

// Success/error handling for forms
document.body.addEventListener('htmx:afterRequest', function(e) {
  if (e.detail.xhr.status === 200 && (e.detail.requestConfig.verb === 'post' || e.detail.requestConfig.verb === 'put' || e.detail.requestConfig.verb === 'delete')) {
    // Refresh list and leave form in place
    htmx.trigger('#functional-areas-list', 'refresh');
  }
});

// Enhance Export link to include current search value as query param
document.getElementById('fa-export-btn')?.addEventListener('click', function(ev) {
  const searchEl = document.getElementById('area-search');
  if (!searchEl) return; // no filter visible
  const base = this.getAttribute('href') || '/functional-areas/export.xlsx';
  const qs = new URLSearchParams();
  if (searchEl.value && searchEl.value.trim() !== '') {
    qs.set('search', searchEl.value.trim());
  }
  // Build final URL (preserve base only if qs is empty)
  const finalUrl = qs.toString() ? `${base}?${qs.toString()}` : base;
  this.setAttribute('href', finalUrl);
});
</script>
{% endblock %}
# End of app/templates/functional_areas.html

# Start of app/templates/agencies.html
<!-- app/templates/agencies.html -->

{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  
  <!-- Page Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-white mb-2">Transit Agency Management</h1>
    <p class="text-slate-400">Manage transit agencies and their organizational structure.</p>
  </div>

  <!-- Stats Overview -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
      <div class="flex items-center justify-between mb-2">
        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
          </svg>
        </div>
        <span class="text-2xl font-bold text-white" hx-get="/api/count/agencies" hx-trigger="load">--</span>
      </div>
      <h3 class="text-slate-400 text-sm font-medium">Total Agencies</h3>
    </div>

    <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
      <div class="flex items-center justify-between mb-2">
        <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
        </div>
        <span class="text-2xl font-bold text-white" id="active-implementations-count">--</span>
      </div>
      <h3 class="text-slate-400 text-sm font-medium">Active Implementations</h3>
    </div>

    <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
      <div class="flex items-center justify-between mb-2">
        <div class="w-10 h-10 bg-gradient-to-r from-cyan-500 to-cyan-600 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"/>
          </svg>
        </div>
        <span class="text-2xl font-bold text-white" id="avg-implementations-count">--</span>
      </div>
      <h3 class="text-slate-400 text-sm font-medium">Avg Tech/Agency</h3>
    </div>

    <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
      <div class="flex items-center justify-between mb-2">
        <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
          </svg>
        </div>
        <span class="text-2xl font-bold text-white" id="avg-vendors-count">--</span>
      </div>
      <h3 class="text-slate-400 text-sm font-medium">Avg Vendors/Agency</h3>
    </div>
  </div>

  <!-- Actions Bar -->
  <div class="glass-effect rounded-xl p-6 border border-slate-700/50 mb-8">
    <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
      
      <!-- Search -->
      <div class="relative flex-1 max-w-md">
        <input type="text" id="agency-search" placeholder="Search transit agencies..." 
               class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:border-blue-500 focus:outline-none"
               hx-get="/api/agencies/list" hx-target="#agencies-list" hx-trigger="keyup changed delay:300ms" 
               hx-vals="js:{search: event.target.value}">
        <svg class="absolute right-3 top-2.5 w-5 h-5 text-slate-400" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
        </svg>
      </div>

      <!-- Actions -->
      <div class="flex gap-2">
        <button hx-get="/api/agencies/form" hx-target="#agency-details" hx-swap="innerHTML"
                class="px-4 py-2 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-lg font-medium hover:from-blue-700 hover:to-cyan-700 transition-all">
          <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
          </svg>
          Add Transit Agency
        </button>
        <button class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg font-medium transition-colors">
          Export
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <!-- Agencies List -->
    <div class="lg:col-span-2">
      <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-semibold text-white">Transit Agencies</h2>
          <button hx-get="/api/agencies/list" hx-target="#agencies-list" 
                  class="px-3 py-1 bg-slate-800 hover:bg-slate-700 rounded text-sm transition-colors">
            <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
            </svg>
            Refresh
          </button>
        </div>
        
        <div id="agencies-list" hx-get="/api/agencies/list" hx-trigger="load">
          <!-- Agencies will be loaded here -->
          <div class="animate-pulse space-y-4">
            <div class="h-24 bg-slate-800 rounded-lg"></div>
            <div class="h-24 bg-slate-800 rounded-lg"></div>
            <div class="h-24 bg-slate-800 rounded-lg"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Details/Form Sidebar -->
    <div class="space-y-6 sticky top-24 max-h-[calc(100vh-6rem)] overflow-y-auto">
      
      <!-- Agency Details Panel -->
      <div id="agency-details">
        <!-- Default state -->
        <div class="glass-effect rounded-xl p-6 border border-slate-700/50 text-center">
          <div class="w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-slate-500" fill="currentColor" viewBox="0 0 20 20">
              <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
            </svg>
          </div>
          <h3 class="text-lg font-medium text-slate-400 mb-2">Agency Details</h3>
          <p class="text-slate-500 text-sm">Click on a transit agency to view details or use the Add button to create a new one.</p>
        </div>
      </div>

      <!-- Agency Insights -->
      <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4">Transit Insights</h3>
        <div class="space-y-3">
          <div class="flex justify-between items-center p-3 bg-slate-800/30 rounded-lg">
            <span class="text-slate-300 text-sm">Tech Leader</span>
            <span class="text-blue-400 font-medium text-sm" id="tech-leader-agency">--</span>
          </div>
          <div class="flex justify-between items-center p-3 bg-slate-800/30 rounded-lg">
            <span class="text-slate-300 text-sm">Top Technology</span>
            <span class="text-green-400 font-medium text-sm" id="common-tech-area">--</span>
          </div>
          <div class="flex justify-between items-center p-3 bg-slate-800/30 rounded-lg">
            <span class="text-slate-300 text-sm">Leading Vendor</span>
            <span class="text-purple-400 font-medium text-sm" id="top-vendor">--</span>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4">Quick Actions</h3>
        <div class="space-y-3">
          <button hx-get="/api/agencies/form" hx-target="#agency-details" hx-swap="innerHTML"
                  class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-lg text-sm font-medium hover:from-blue-700 hover:to-cyan-700 transition-all text-white shadow-lg">
            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
            </svg>
            Add New Agency
          </button>
          <button class="w-full px-4 py-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm font-medium transition-colors text-white">
            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
              <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a2 2 0 00-2 2v6a2 2 0 002 2h8a2 2 0 002-2V6a2 2 0 00-2-2V3a2 2 0 012 2v8a4 4 0 01-4 4H6a4 4 0 01-4-4V5z" clip-rule="evenodd"/>
            </svg>
            Agency Report
          </button>
          <button class="w-full px-4 py-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm font-medium transition-colors text-white">
            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
            Export Data
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load agency stats
document.addEventListener('DOMContentLoaded', function() {
  fetch('/api/agencies/stats')
    .then(response => response.json())
    .then(data => {
      document.getElementById('active-implementations-count').textContent = data.active_implementations;
      document.getElementById('avg-implementations-count').textContent = data.avg_implementations_per_agency;
      document.getElementById('avg-vendors-count').textContent = data.avg_vendors_per_agency;
    });

  // Load agency insights
  fetch('/api/agencies/insights')
    .then(response => response.json())
    .then(data => {
      document.getElementById('tech-leader-agency').textContent = data.tech_leader;
      document.getElementById('common-tech-area').textContent = data.common_area;
      document.getElementById('top-vendor').textContent = data.top_vendor;
    });
});

// Auto-refresh stats every 30 seconds
setInterval(function() {
  const elements = document.querySelectorAll('[hx-get*="/api/count/"]');
  elements.forEach(el => htmx.trigger(el, 'refresh'));
}, 30000);

// Success/error handling for forms
document.body.addEventListener('htmx:afterRequest', function(e) {
  if (e.detail.xhr.status === 200 && e.detail.requestConfig.verb === 'post') {
    // Success: refresh list and show success message
    htmx.trigger('#agencies-list', 'refresh');
  }
});
</script>
{% endblock %}
# End of app/templates/agencies.html

# Start of app/templates/configurations.html
{% extends 'base.html' %}
{% block content %}
<div class="px-6 py-6">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-bold text-white">Configurations</h1>
    <a href="/configurations/import" 
       class="inline-flex items-center gap-2 px-3 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-sm transition-colors">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
      </svg>
      Import CSV
    </a>
  </div>
  <div class="flex flex-col md:flex-row md:items-center md:space-x-4 gap-2 mb-4">
    <select id="filter-agency" name="agency_id" class="bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-200"
            hx-get="/api/configurations/list" hx-target="#config-list" hx-include="#filter-agency,#filter-function,#filter-status">
      <option value="">All Agencies</option>
      {% for a in agencies %}
      <option value="{{ a.id }}" {% if selected_agency_id and a.id == selected_agency_id %}selected{% endif %}>{{ a.name }}</option>
      {% endfor %}
    </select>
    <div class="flex items-center gap-2">
      <input id="filter-function-search" name="q" type="text" placeholder="Search functions..."
             class="bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-200 w-48"
             hx-get="/api/options/functions" hx-target="#filter-function" hx-trigger="keyup changed delay:300ms"
             hx-include="#filter-function-search">
      <select id="filter-function" name="function_id" class="bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-200"
              hx-get="/api/configurations/list" hx-target="#config-list" hx-include="#filter-agency,#filter-function,#filter-status">
        <option value="">All Functions</option>
        {% for f in functions %}
        <option value="{{ f.id }}">{{ f.name }}</option>
        {% endfor %}
      </select>
    </div>
    <select id="filter-status" name="status" class="bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-200"
            hx-get="/api/configurations/list" hx-target="#config-list" hx-include="#filter-agency,#filter-function,#filter-status">
      <option value="">All Statuses</option>
      <option value="Active">Active</option>
      <option value="Planned">Planned</option>
      <option value="Retired">Retired</option>
      <option value="Draft">Draft</option>
    </select>
  </div>
  <div id="config-list" hx-get="/api/configurations/list" hx-trigger="load">
    <div class="text-slate-500 text-sm">Loading...</div>
  </div>
  <div id="configuration-details" class="mt-4"></div>
  <div class="mt-8">
    <h2 class="text-xl text-white font-semibold mb-2">Quick Create</h2>
    <form hx-post="/api/configurations" hx-target="#config-list" hx-swap="beforebegin" class="space-y-3">
      {% if selected_agency_id %}
        <input type="hidden" name="agency_id" value="{{ selected_agency_id }}" />
        <div class="text-xs text-slate-400">Agency preselected.</div>
      {% else %}
        <div>
          <label class="block text-xs text-slate-400 mb-1">Agency</label>
          <select name="agency_id" class="bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-200 w-full">
            {% for a in agencies %}<option value="{{ a.id }}">{{ a.name }}</option>{% endfor %}
          </select>
        </div>
      {% endif %}

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="block text-xs text-slate-400 mb-1">Functional Area</label>
          <select id="qc-fa"
                  class="bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-200 w-full"
                  hx-get="/api/options/functions" hx-target="#qc-function" hx-trigger="change"
                  hx-include="#qc-fa,#qc-function-search">
            <option value="">All Functional Areas</option>
          </select>
        </div>
        <div>
          <label class="block text-xs text-slate-400 mb-1">Search Functions</label>
          <input id="qc-function-search" name="q" type="text" placeholder="Type to search..."
                 class="bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-200 w-full"
                 hx-get="/api/options/functions" hx-target="#qc-function" hx-trigger="keyup changed delay:300ms"
                 hx-include="#qc-fa,#qc-function-search" />
        </div>
        <div>
          <label class="block text-xs text-slate-400 mb-1">Function</label>
          <select id="qc-function" name="function_id" class="bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-200 w-full"
                  hx-get="/api/options/components" hx-target="#qc-component" hx-trigger="change" hx-include="#qc-function">
            <option value="">Select a function</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-xs text-slate-400 mb-1">Component</label>
          <select id="qc-component" name="component_id" class="bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-200 w-full">
            <option value="">Select a component</option>
          </select>
        </div>
        <div>
          <label class="block text-xs text-slate-400 mb-1">Status</label>
          <select name="status" class="bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-200 w-full">
            <option value="Active">Active</option>
            <option value="Planned">Planned</option>
            <option value="Retired">Retired</option>
            <option value="Draft">Draft</option>
          </select>
        </div>
      </div>

      <button class="px-3 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm">Create</button>
    </form>
    <div class="mt-4">
      <h3 class="text-white font-semibold mb-2">Wizard</h3>
      <!-- Populate FA options for Quick Create on load -->
      <div hx-get="/api/options/functional-areas" hx-target="#qc-fa" hx-trigger="load"></div>
      <div id="wizard"
           {% if selected_agency_id %}
             hx-get="/api/wizard/config/step1?agency_id={{ selected_agency_id }}"
           {% else %}
             hx-get="/api/wizard/config/step1"
           {% endif %}
           hx-trigger="load"></div>
    </div>
  </div>
</div>
{% endblock %}

# End of app/templates/configurations.html

# Start of app/templates/component_detail.html
{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <a href="/components" class="inline-flex items-center text-slate-300 hover:text-white text-sm mb-6">
    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4A1 1 0 018.707 6.707L6.414 9H17a1 1 0 110 2H6.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd"/></svg>
    Back to Components
  </a>

  <div class="flex items-start justify-between mb-4 gap-4">
    <div class="flex items-center flex-wrap gap-2">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-white leading-tight">{{ component.name }}</h1>
      {% if component.is_composite %}
        <span class="px-2 py-1 bg-blue-600/20 border border-blue-600/30 rounded text-xs text-blue-300">Composite</span>
      {% endif %}
    </div>
    <div class="flex items-center gap-2 shrink-0">
      <button
        hx-get="/api/components/{{ component.id }}/form"
        hx-target="#component-form-container"
        hx-swap="innerHTML"
        class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs sm:text-sm text-white border border-slate-600/60 transition-colors">
        Edit
      </button>
      <button id="delete-component-btn"
              data-component-id="{{ component.id }}"
              class="px-3 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-xs sm:text-sm text-white border border-red-600/60 transition-colors">
        Delete
      </button>
    </div>
  </div>

  <!-- Inline form container (appears when editing) -->
  <div id="component-form-container" class="mb-8"></div>

  <div class="grid grid-cols-1 gap-6">
    <!-- Key facts -->
    <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-base">
        <div class="space-y-1">
          <p class="text-slate-400">Version</p>
          <p class="text-white font-medium text-lg">{{ component.version or 'Unknown' }}</p>
        </div>
        <div class="space-y-1">
          <p class="text-slate-400">Deployment Date</p>
          <p class="text-white font-medium text-lg">{{ component.deployment_date.strftime('%B %d, %Y') if component.deployment_date else 'Unknown' }}</p>
        </div>
        <div class="space-y-1">
          <p class="text-slate-400">Update Frequency</p>
          <p class="text-white font-medium text-lg">{{ component.update_frequency or 'Unknown' }}</p>
        </div>
        <div class="space-y-1">
          <p class="text-slate-400">Vendor</p>
          <p class="text-white font-medium text-lg">{{ component.vendor.name if component.vendor else 'No Vendor' }}</p>
        </div>
      </div>
      {% if component.known_issues %}
      <div class="mt-6 bg-red-900/20 border border-red-700/30 rounded p-4">
        <h3 class="text-red-300 font-semibold mb-2">Known Issues</h3>
        <p class="text-red-200">{{ component.known_issues }}</p>
      </div>
      {% else %}
      <div class="mt-6 bg-green-900/20 border border-green-700/30 rounded p-4">
        <h3 class="text-green-300 font-semibold mb-2">Status</h3>
        <p class="text-green-200">No known issues</p>
      </div>
      {% endif %}
    </div>

    <!-- Implementations by Agency -->
    <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
      <h2 class="text-2xl font-bold text-white mb-4">Agency Implementations</h2>
      {% if implementations_by_agency %}
        <div class="space-y-4">
          {% for agency_name, impls in implementations_by_agency.items() %}
            <div>
              <h3 class="text-blue-300 font-semibold mb-2">{{ agency_name }}</h3>
              <div class="space-y-2">
                {% for impl in impls %}
                  <div class="flex items-center justify-between p-3 bg-slate-700/30 rounded">
                    <div class="flex items-center space-x-2">
                      <span class="w-2 h-2 rounded-full {{ 'bg-green-500' if impl.status == 'Active' else 'bg-yellow-500' }}"></span>
                      <span class="text-slate-200">{{ impl.function.name }}</span>
                      <span class="text-slate-400 text-xs">({{ impl.function.functional_area.name }})</span>
                    </div>
                    <div class="text-right">
                      <span class="text-xs text-slate-400">{{ impl.deployment_date.strftime('%Y-%m-%d') if impl.deployment_date else 'No date' }}</span>
                      {% if impl.version %}
                        <br><span class="text-xs text-slate-500">v{{ impl.version }}</span>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-slate-400">No agency usage tracked for this component.</p>
      {% endif %}
    </div>

    <!-- Integrations -->
    <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
      <h2 class="text-2xl font-bold text-white mb-4">Integrations</h2>
      {% if integrations %}
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          {% for ip in integrations %}
            <div class="p-3 bg-slate-700/30 rounded">
              <div class="flex items-center justify-between">
                <span class="text-slate-200">{{ ip.name }}</span>
                <span class="text-xs text-slate-400">{{ ip.integration_type or 'Standard' }}</span>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-slate-400">No integrations configured.</p>
      {% endif %}
    </div>

    <!-- Additional Metadata -->
    {% if component.additional_metadata %}
      <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
        <h2 class="text-2xl font-bold text-white mb-4">Additional Information</h2>
        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          {% for key, value in component.additional_metadata.items() %}
          <div>
            <dt class="text-slate-400">{{ key.replace('_', ' ').title() }}</dt>
            <dd class="text-white font-medium">{{ value }}</dd>
          </div>
          {% endfor %}
        </dl>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Delete component (full detail page)
document.addEventListener('click', function(e){
  if(e.target && e.target.id === 'delete-component-btn'){
    const btn = e.target;
    const id = btn.dataset.componentId;
    if(!confirm('Delete this component? This cannot be undone.')) return;
    btn.disabled = true; const original = btn.textContent; btn.textContent='Deleting...';
    const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    fetch(`/api/components/${id}`, { method:'DELETE', headers: { 'X-CSRFToken': token, 'Accept': 'application/json' } })
      .then(r=>r.json())
      .then(data=>{
        showToast(data.message, data.status==='success');
        if(data.status==='success'){
          window.location = '/components';
        } else {
          btn.disabled=false; btn.textContent=original;
        }
      })
      .catch(()=>{ showToast('Delete failed', false); btn.disabled=false; btn.textContent=original; });
  }
});
</script>
{% endblock %}

# End of app/templates/component_detail.html

# Start of README.md
See-Tran — Open source transit technology modeling and benchmarking
=================================================================

See-Tran is an open-source web application for modeling a transit agency’s technology landscape and benchmarking across agencies. It helps transit technology professionals catalog functional areas, map functions to components, track vendor products and versions, and understand integration points across the stack.

What you can do with See-Tran
- Model your current-state architecture: agencies → functional areas → functions → components
- Track real deployments using Configurations (agency + function + component)
- Map vendor Products and Product Versions used within each configuration
- Analyze vendor footprint and usage across agencies/functions
- View and share clean, print-friendly summaries for Functional Areas and Functions
- Browse internal documentation in-app (Markdown-based, at /docs)

Who it’s for
- Transit CIOs/CTOs and enterprise architects
- IT managers and application owners
- Vendor managers and procurement teams
- Analysts benchmarking capabilities and vendor presence across agencies

Core domain model (high level)
- Agency: A public transit organization using the platform
- FunctionalArea: A business domain (e.g., Operations, Maintenance, Planning)
- Function: A specific capability within a Functional Area; includes Criticality (high/medium/low)
- Component: A system or subsystem that implements one or more Functions
- Configuration: The key implementation record tying an Agency + Function + Component together, with status, deployment date, version label, and notes
- Vendor: A technology provider
- Product and ProductVersion: Vendor offerings and their releases; Products can be linked to Configurations via ConfigurationProduct
- IntegrationPoint and Standard: Where systems connect and which standards apply
- Tags and TagGroups: Lightweight classification for components/integrations

Key features (current)
- Functional Areas and Functions
	- Management UI with search and details
	- Print views:
		- /functional-areas/print — grid of all Functional Areas
		- /functions/print — all Functions grouped by Functional Area with criticality and quick counts
- Components
	- List with agency and function usage summaries (derived from Configurations)
	- Rich details pane including deployment recency, roles, and additional metadata
- Vendors and Products
	- Vendor list with product and usage counts (based on Product ↔ ConfigurationProduct links)
	- Vendor details grouped by Functional Area with used/unused products
	- Basic performance and usage metrics (most versions, most recent release, most used vendor)
- Agencies
	- List with synthetic implementation counts derived from Configurations
	- Basic stats: active implementations, average implementations per agency, average vendors per agency
- Configurations
	- The backbone of usage/benchmarking: each record represents a deployed component for a function at an agency
	- Supports associated products/versions through ConfigurationProduct
- Integrations and Standards
	- Integration points and referenced standards (basic list + relationships)
- Documentation (/docs)
	- Markdown-driven docs rendered in-app (fenced code, tables)
	- Responsive docs layout with sticky sidebar on desktop and a mobile drawer
- Accessibility and printing
	- Tailwind-based, responsive UI
	- Print-optimized pages for clean exports and sharing

Architecture and tech
- Backend: Flask (Python), SQLAlchemy ORM, Flask-Migrate (Alembic)
- Frontend: Jinja templates, Tailwind CSS, HTMX for dynamic fragments
- Auth: OAuth (Microsoft/Google) support in the hosted build
- Data: JSON bootstrap files and loader scripts in /data and /scripts
- Tests: Pytest stubs for health checks and core pages

Repository structure (selected)
- app/models/tran.py — Core data models (Agency, FunctionalArea, Function, Component, Vendor, Product, ProductVersion, Configuration, etc.)
- app/routes/ — Flask blueprints and HTML fragment endpoints
- app/templates/ — Jinja templates (pages and fragments)
- data/ — Seed JSON files for agencies, vendors, components, functions, etc.
- scripts/ — One-off data loader scripts
- tests/ — Basic tests and scaffolding

Getting started (local development)
1) Python environment
	 - Python 3.12+ recommended
	 - Create a virtual environment and install dependencies:
		 - python -m venv .venv
		 - source .venv/bin/activate
		 - pip install -r requirements.txt
	 - Note: Markdown is required for /docs (tracked in requirements.txt)

2) Run the app
	 - export FLASK_APP=run.py
	 - flask run
	 - Visit http://localhost:5000

3) Optional: load seed data
	 - Review /scripts and /data for example loaders
	 - Ensure database migrations are initialized (Flask-Migrate/Alembic)

Modeling and benchmarking tips
- Use Functional Areas and Functions to define business capabilities and their criticality
- Use Components to represent systems; relate them to Functions
- Create Configurations for each real deployment at an Agency; include dates and status
- Link Products and Product Versions to Configurations via ConfigurationProduct to track vendor footprint
- Use the Vendors pages to see product counts and active usage across agencies/functions
- Use the print pages to circulate summaries in meetings or attach to reports

Security and access
- Public pages: landing and agency list (config-dependent)
- Auth-protected pages for management and benchmarking screens
- OAuth (Microsoft/Google) supported for hosted builds; registration limited to known agency/vendor domains
- Super admin role (config) with full access; agency/vendor-level roles planned/available per route configuration

Roadmap (abridged)
- Deeper benchmarking dashboards (cross-agency comparisons, trends)
- Enhanced integration mapping and standards coverage
- Vendor/agency news feeds and alerts
- Collaboration features for community curation

Contributing
We welcome contributions from public transit teams and industry partners. Please open issues for bugs and feature requests, and submit pull requests for proposed changes. See the project docs (/docs) for domain notes and contribution guidelines as they evolve.

Hosted option
See-Tran.org provides a hosted instance with community-sourced data enhanced by AI agents for discovery and normalization. Contact the maintainers if you’d like to participate or pilot.

# End of README.md

